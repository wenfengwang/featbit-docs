import { Callout } from 'nextra/components'

# 定位规则

## 概览 <a href="#overview" id="overview"></a>

本主题解释了如何使用定位规则根据用户的内置和自定义用户属性来针对特定用户群。

## 创建定位规则 <a href="#creating-targeting-rules" id="creating-targeting-rules"></a>

定位规则可以包含一个或多个条件。

每个条件包括三个部分：

* 内置或自定义的**user attribute**，它定义了条件影响的范围，例如只针对电子邮件地址。要了解更多，请阅读[用户属性](targeting-rules.mdx#user-attributes)。
* **operator**，它设定了属性的区分特征，例如限制条件只针对以某些后缀结尾的电子邮件。如果一个条件为运算符指定了多个值，运算符会遍历这个数组。要了解更多，请阅读[运算符](targeting-rules.mdx#operators)。
* **value**，它通过您指定的值来识别属性，例如 `gmail.com`。

这是一个用户定位规则的图像：

![](../../feature-flags/assets/targeting-users-with-flags/targeting-rules/001.webp)

要创建一个规则，为电子邮件地址以 `gmail.com` 结尾的所有用户提供 `true`：

1. 点击 **Add rules** 图标。

![](../../feature-flags/assets/targeting-users-with-flags/targeting-rules/002.webp)

2. 为规则输入一个名称。
3. 从 **Select an attribute** 菜单中选择 `email`。
4. 从 **Select an operator** 菜单中选择 `ends with`。
5. 在 **values** 字段中输入 `gmail.com`。
6. 从 **serve** 菜单中选择 `true`。
7. 点击 **save**。

如果定位规则引用了任何具有 `null` 值的自定义属性，则该标志会跳过该规则。

您可以为一个规则添加多个条件。以下是规则处理多个条件和值的方式：

* 用户必须满足规则中的所有条件才能匹配该规则。如果任何条件不满足，用户将不会匹配该规则。
* 如果一个条件有多个值，FeatBit 认为条件满足，如果 _任何_ 值匹配。

#### 百分比发布 <a href="#percentage-rollouts" id="percentage-rollouts"></a>

如果您只想让符合规则的一部分用户接收特定的变体，您可以设置百分比发布。

这是百分比发布部分的图像：

在这个例子中，25% 的用户将接收 `true` 变体。

![](../../feature-flags/assets/targeting-users-with-flags/targeting-rules/003.webp)

要了解更多，请阅读[百分比发布](percentage-rollouts.md)。

#### 实验 <a href="#experimentation" id="experimentation"></a>

保存定位规则后，您可以点击 **Set A/B test rule** 按钮来对该规则进行实验。要了解更多，请阅读[创建实验](../../experimentation/creating-experiments.md)。

这是一个标志的定位规则上的 **Set A/B test rule** 按钮的图像：

![](../../feature-flags/assets/targeting-users-with-flags/targeting-rules/004.webp)

#### 用户属性 <a href="#user-attributes" id="user-attributes"></a>

FeatBit 包含了用户的内置属性。以下是一些常见的用户属性示例：

* `keyId`
* `name`

完整的内置用户属性列表，请阅读[内置用户属性](../users-and-user-segments/user-attributes.md)。

FeatBit 也允许您创建自己的自定义用户属性。例如，您可能想根据计划、小组、角色、地点或组织来定位用户。使用自定义用户属性，您可以向标准计划的用户展示一些功能，并向高级计划的用户展示额外的功能。或者，您可以向30%的组织推出一个新功能，而不是向30%的用户推出。

要了解更多，请阅读[用户属性](../users-and-user-segments/user-attributes.md)。

#### 运算符 <a href="#operators" id="operators"></a>

FeatBit 支持以下运算符：

| 运算符 | 属性类型 | 含义 |
| ------------------------------------ | ------------- | ------------ |
| 是 `=` 之一，不是 `!=` 之一 | 字符串、数字、布尔、日期 | 精确匹配 |
| 以...结束，不以...结束 | 字符串 | 字符串后缀匹配 |
| 以...开始，不以...开始 | 字符串 | 字符串前缀匹配 |
| 匹配，不匹配 | 字符串 | 正则表达式匹配 |
| 包含，不包含 | 字符串 | 子字符串匹配 |
| 大于 `>`，小于 `<`，大于或等于 `>=`，小于或等于 `<=` | 数字 | 数值比较 |
| 用户在细分中，用户不在细分中 | 细分名称 | 用户是否被命名细分的定位规则包含或排除。要了解更多，请阅读[用户细分](../users-and-user-segments/user-segments)。 |

## 设置默认规则 <a href="#setting-the-default-rule" id="setting-the-default-rule"></a>

FeatBit 定义了一个最终的默认规则，适用于所有未匹配页面上任何定位规则的用户。与其他规则一样，您可以选择提供特定的变体，或对任何剩余的用户应用百分比发布。

这是百分比发布部分的图像：

![](../../feature-flags/assets/targeting-users-with-flags/targeting-rules/005.webp)

现在，所有未被其他规则定位的用户中有30%将接收 `true`。

如果您不想基于用户键或任何自定义属性定位用户，您可以使用默认规则来控制所有用户的标志发布。

## 设置默认关闭变体 <a href="#setting-the-default-off-variation" id="setting-the-default-off-variation"></a>

当开关关闭时，FeatBit 将为您的功能标志提供默认关闭变体。对于布尔标志，默认关闭变体设置为 `false`。对于多变量标志，您可以选择您的自定义变体之一。您可以在 **Targeting** 标签中自定义布尔和多变量标志的默认关闭变体。

## 评估顺序 <a href="#evaluation-order" id="evaluation-order"></a>

**Targeting** 标签按以下顺序评估规则：

### 如果功能开启

1. 针对单个用户 \
![](../../feature-flags/assets/targeting-users-with-flags/targeting-rules/006.webp)
   1. 第一变体
   2. 第二变体
   3. 第三变体
   4. ...
2. 针对用户自定义规则 \
![](../../feature-flags/assets/targeting-users-with-flags/targeting-rules/007.webp)
   1. UI 中显示的第一条规则
   2. UI 中显示的第二条规则
   3. UI 中显示的第三条规则
   4. ...
3. 通过 **Default Rule** 中的配置针对剩余用户

<Callout type="info">
如果用户匹配多个规则，将应用第一个匹配的规则。
可以通过点击规则左侧边缘并拖动来重新排序自定义规则。
</Callout>

### 如果功能关闭

提供 OFF 部分预定义的变体 \

![](../../feature-flags/assets/targeting-users-with-flags/targeting-rules/008.webp)
