import { 提示 } from 'nextra/components'

# 架构


<Callout type="info" >
  本文档适用于标准版，请参考[专业版架构](architecture-professional.md)了解专业版。有关标准版和专业版的区别，请查看[标准版 VS 专业版](standard-vs.-professional.md)。
</Callout>

## **概述**

FeatBit 是一个**可扩展**且**快速**的功能管理平台。FeatBit 的使命是赋予所有团队交付、控制、进行实验和实现软件货币化的能力。

整体架构如下：

![](../tech-stack/assets/architecture/001.webp)

* **UI：** 为用户提供可视化的 UI 界面，用于管理和发布功能标志、区段、实验等。
* **API 服务器：** 为 UI 和外部集成服务提供数据管理功能，例如标志触发器、代码引用等。
* **评估服务器：** 提供可扩展且高性能的标志规则评估引擎和数据分发服务器。
* **数据分析服务器：** 提供数据分析引擎。它确保以下服务
  * 计算实验并几乎实时返回其结果。
  * 为 UI 中的所有分析提供见解服务，例如功能标志报告。
* **SDK：** 我们为所有主要语言和框架提供 SDK，使您能够快速访问 FeatBit 的服务和应用程序。
* **Redis：** 它具有两个角色
  * 作为缓存层以提升性能。
  * 作为消息队列，确保不同服务之间的高吞吐量异步数据通信。
* **MongoDB：** 主数据库。所有功能标志、区段、实验、最终用户和分析数据都存储在 MongoDB 中。

## 可扩展和高性能

在设计架构时，我们唯一关心的是如何使其可扩展和获得最佳性能。为此，我们精心选择了我们的技术堆栈，并将所有服务容器化，这使得它非常容易部署为集群并**水平扩展**。

至于数据存储和服务之间的数据流，为了获得最佳性能，我们引入了 MongoDB 作为我们的主数据存储，Redis 作为系统缓存和消息队列。我们使用**多路复用**和**发布与订阅系统**在服务之间发送/接收消息，平均反应时间为毫秒级。

将功能标志更改或其他配置推送到 SDK 几乎是实时的。当从 UI 更改标志时，将数据推送到 SDK 的时间不到**100**毫秒。我们采用 WebSocket 解决方案，而不是长轮询，因为它可以在更改发生后主动推送到 SDK。当然，这并非免费，当出现大量并发请求时，它会消耗大量内存。为了避免成为内存占用过大的问题，我们精心选择了序列化和反序列化数据的方式，以确保在序列化和反序列化过程中不会消耗额外的内存。

## 数据流

系统运行时，数据在不同服务之间流动。有四个主要的数据流：

### 数据同步（功能标志/区段）数据流

功能标志/区段数据存储在 MongoDB 中，它是 FeatBit 所有主要功能的最重要数据存储。

客户端或服务器 SDK 与评估服务器建立连接后，SDK 将发送附带最新更改时间戳的数据同步请求到评估服务器，评估服务器将检查该时间戳并从 Redis 获取符合条件的功能标志和区段。在最终评估过程（仅适用于客户端 SDK）后，结果将发送回 SDK。响应有以下两种类型：

* **full**：响应包含所有功能标志和区段
* **patch**：响应仅包含自时间戳以来创建或更新的新功能标志和区段

![](../tech-stack/assets/architecture/002.png)

### 功能标志/区段更改数据流

当用户从 UI 更改功能标志或区段时，API 服务器除了在 MongoDB 中存储数据外，还将更改推送到 Kafka，评估服务器读取这些更改、更新 Redis、评估与更改相关的功能标志，并通过 WebSocket 连接将相关功能标志或评估结果发送到客户端/服务器端 SDK。

![](../tech-stack/assets/architecture/003.png)

### 最终用户数据流

最终用户数据存储在 MongoDB 中，用于功能标志和区段的定位。

当客户端 SDK 建立 WebSocket 连接或切换到另一个用户（通过调用标识 API）时，或者客户端/服务器 SDK 发送跟踪消息时，评估服务器将最终用户信息发送到 Kafka，然后 API 服务器读取该数据并更新/插入到 MongoDB 中。

![](../tech-stack/assets/architecture/004.png)

### 功能标志和指标跟踪数据流

功能标志和指标跟踪数据存储在 ClickHouse 中，用于 A/B/n 测试（实验）和报告。

当客户端/服务器 SDK 向评估服务器发送功能标志和指标跟踪消息时，后者将跟踪消息转发到 Kafka，数据分析服务器从 Kafka 读取跟踪消息并将其存储在 ClickHouse 中。

![](../tech-stack/assets/architecture/005.png)

## **您是所有数据的唯一所有者**

整体架构还确保了隐私方面，因为所有数据和通信都保留在系统内部。不会向任何第三方服务发送任何数据。您是所有数据的唯一所有者，这也使我们能够自信地声明我们完全符合 [GDPR](https://gdpr-info.eu/) 的要求。
