import { Callout } from 'nextra/components'

# 架构 - 专业版

<Callout type="info" >
本文档适用于专业版，如需标准版请参考 [Architecture](architecture.md)[](architecture.md)。关于标准版和专业版的区别，请查看[标准版 VS 专业版](standard-vs.-professional.md)。
</Callout>

## **概览**

FeatBit 是一个 **可扩展** 且 **快速** 的特性管理平台。FeatBit 的使命是赋能所有团队交付、控制、试验他们的软件并从中获益。

整体架构如下：

![](../tech-stack/assets/architecture-professional/001.png)

* **UI：** 为用户提供可视化 UI 界面，用于管理和发布功能标志、细分和实验等。
* **API 服务器：** 为 UI 和外部集成服务提供数据管理能力，例如标志触发器、代码引用等。
* **评估服务器：** 提供可扩展且高性能的标志规则评估引擎和数据分发服务器。
* **数据分析服务器：** 提供数据分析引擎。它确保以下服务：
  * 计算实验并近乎实时返回其结果。
  * 为 UI 中的所有分析提供洞察服务，例如特性标志报告。
* **SDK：** 我们为所有主要语言和框架提供 SDK，使您能够快速从您的服务和应用程序访问 FeatBit。
* **Redis：** 缓存层，用于提升性能。
* **Kafka：** 消息队列，确保不同服务之间高吞吐量的异步数据通信。它不仅提升了整体性能，还解耦了服务。
* **MongoDB：** 主数据库。所有特性标志、细分、实验和最终用户数据都存储在 MongoDB 中。
* **ClickHouse：** 用于分析服务的数据库。您可以在其中找到所有特性调用和指标调用日志。

## 可扩展性和高性能

在设计架构时，我们最重要且唯一的关注点是如何使其可扩展以及如何获得最佳性能。为此，我们精心挑选了技术栈，并将所有服务容器化，这使得它非常容易部署为集群并 **水平扩展**。

对于数据存储和服务之间的数据流动，为了获得最佳性能，我们引入了 MongoDB 作为主数据存储，Redis 作为系统缓存，Kafka 作为消息队列，ClickHouse 作为分析和 A/B/n 测试数据的数据存储等。我们使用 **多路复用** 和 **发布订阅系统** 在服务之间发送/接收消息，平均响应时间以毫秒计。

当从 UI 更改特性标志或其他配置时，推送到 SDK 的数据几乎是实时的。数据推送到 SDK 的时间少于 **100** 毫秒。我们采用了 WebSocket 解决方案而非长轮询，因为它可以在变更发生后立即主动推送到 SDK。当然，这并非没有成本，当发生大量并发请求时，它可能会消耗大量内存。为了避免成为内存怪兽，我们精心选择了序列化和反序列化数据的方式，以确保在序列化和反序列化过程中不会消耗额外内存。

## 数据流动

当系统运行时，数据在不同服务之间流动。主要有四个数据流：

### 数据同步（特性标志/细分）数据流

特性标志/细分数据存储在 MongoDB 中，它是最重要的数据存储，服务于 FeatBit 的所有主要功能。

在客户端或服务器 SDK 与评估服务器建立连接后，SDK 会发送带有最新更改时间戳的数据同步请求到评估服务器，评估服务器会检查该时间戳并从 Redis 获取符合条件的特性标志和细分，经过最终评估过程（仅适用于客户端 SDK）后，将结果发送回 SDK。响应有以下两种类型：

* **full**：响应包含所有特性标志和细分
* **patch**：响应仅包含自时间戳以来创建或更新的新特性标志和细分

![](../tech-stack/assets/architecture-professional/002.png)

### 特性标志/细分更改数据流

当用户从 UI 更改特性标志或细分时，除了在 MongoDB 中存储数据外，API 服务器还会将更改推送到 Kafka，评估服务器读取这些更改、更新 Redis、评估与更改相关的特性标志，并通过 WebSocket 连接将相关特性标志或评估结果发送到客户端/服务器端 SDK。

![](../tech-stack/assets/architecture-professional/003.png)

### 最终用户数据流

最终用户数据存储在 MongoDB 中，用于特性标志和细分定位。

当客户端 SDK 建立 WebSocket 连接或切换到另一个用户（通过调用 identify API）时，或客户端/服务器 SDK 发送 track 消息时，评估服务器将最终用户信息发送到 Kafka，然后 API 服务器读取该数据并更新/插入 MongoDB。

![](../tech-stack/assets/architecture-professional/004.png)

### 特性标志和指标跟踪数据流

特性标志和指标跟踪数据存储在 ClickHouse 中，用于 A/B/n 测试（实验）和报告。

当客户端/服务器 SDK 向评估服务器发送特性标志和指标跟踪消息时，评估服务器将跟踪消息转发到 Kafka，数据分析服务器从 Kafka 读取跟踪消息并将其存储在 ClickHouse 中。

![](../tech-stack/assets/architecture-professional/005.png)

## **您是所有数据的唯一所有者**

整体架构还确保了隐私方面的考虑，因为所有数据和通信都保留在系统内部。它不会向任何第三方服务发送任何数据。您是您所有数据的唯一所有者，这也使我们能够自信地声明我们完全符合 [GDPR](https://gdpr-info.eu/) 的要求。
