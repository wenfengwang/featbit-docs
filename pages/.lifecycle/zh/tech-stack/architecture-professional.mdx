
从 'nextra/components' 导入 { Callout }

# 建筑学 - 专业篇

<Callout type="info" >
This document is intended for the professional version, please refer to [Architechture](architecture.md)[ ](architecture.md)for the standard version instead.  For the differences between standard and professional versions, please check [Standard VS. Professional](standard-vs.-professional.md).
</Callout>


## **概览**

FeatBit 是一个**可扩展**且**响应迅速**的特性管理平台。FeatBit 的使命是赋予所有团队交付、控制、试验他们的软件并从中获益的能力。

整体架构如下所示：

![](../tech-stack/assets/architecture-professional/001.png)

* **UI :** 为用户提供一个视觉界面，用于管理和发布功能标志、细分市场和实验等。
* **API 服务器：**为 UI 和外部集成服务提供数据管理能力，比如标志触发器、代码引用等。
* **评估服务器：**提供一个可扩展的、高性能的标志规则评估引擎和数据分发服务器。
* **数据分析服务器：**提供数据分析引擎。它确保以下服务：
  * 几乎实时地计算实验并返回结果。
  * 为 UI 中的所有分析提供洞察服务，例如功能标志报告。
* **SDK:** 我们为所有主要编程语言和框架提供了 SDK，使您能够快速从您的服务和应用程序中访问 FeatBit。
* **Redis：** 用于提升性能的缓存层。
* **Kafka :** 消息队列，确保不同服务之间高吞吐量的异步数据通信。它不仅提升了整体性能，还实现了服务的解耦。
* **MongoDB**：主数据库。所有的功能标志、细分市场、实验和最终用户数据都存储在**MongoDB**中。
* **ClickHouse :** 用于分析服务的数据库。您可以在这里找到所有的功能调用和指标调用日志。

## 可扩展性和高性能

在设计架构时，我们最关注的是如何确保系统的可扩展性和尽可能高的性能。为此，我们精心挑选了技术栈并将所有服务容器化，这使得它们非常容易被作为集群部署和**横向扩展**。

至于数据存储和服务之间的数据流动，为了获得最佳性能，我们引入了 MongoDB 作为主数据存储，Redis 作为系统缓存，Kafka 作为消息队列，ClickHouse 作为分析和 A/B/n 测试数据的数据存储等。我们使用**多路复用**和**发布/订阅系统**在服务之间发送/接收消息，平均响应时间以毫秒计。

功能标志变更或其他配置的推送到 SDK 几乎是实时的。当 UI 中的标志发生变化时，推送数据到 SDK 的时间不到**100**毫秒。我们采用了 WebSocket 解决方案而不是长轮询，因为它可以在变更发生时主动推送到 SDK。当然，这并非没有代价，当发生大量并发请求时，它可能会消耗大量内存。为了避免成为内存怪兽，我们仔细选择了序列化和反序列化数据的方式，以确保在这个过程中不会消耗额外的内存。

## 数据流向

当系统运行时，数据在不同服务之间流动。主要有四种数据流向：

### 数据同步（功能标志/细分市场）数据流

功能标志/细分市场数据存储在 MongoDB 中，它是最重要的数据存储，为 FeatBit 的所有主要功能提供服务。

客户端或服务器 SDK 与评估服务器建立连接后，SDK 会发送一个附带最新变更时间戳的数据同步请求给评估服务器，评估服务器会检查该时间戳并从 Redis 中获取符合条件的功能标志和细分市场，经过最终的评估过程（仅对客户端 SDK），结果会被发送回 SDK。响应分为两种类型之一：

* **完整**：响应包含所有功能标志和细分市场
* **补丁**：响应仅包含自时间戳以来创建或更新的新功能标志和细分市场

![](../tech-stack/assets/architecture-professional/002.png)

### 功能标志/细分市场变更数据流

当用户从 UI 更改功能标志或细分市场时，除了在 MongoDB 中存储数据外，API 服务器还会将变更推送至 Kafka，评估服务器读取这些变更，更新 Redis，评估与变更相关的功能标志，并通过 WebSocket 连接将相关的功能标志或评估结果发送给客户端/服务器端 SDK。

![](../tech-stack/assets/architecture-professional/003.png)

### 最终用户数据流

最终用户数据存储在 MongoDB 中，用于功能标志和细分市场的定位。

当客户端 SDK 建立 WebSocket 连接或切换到另一个用户（通过调用识别 API），或客户端/服务器 SDK 发送跟踪消息时，评估服务器会将最终用户信息发送到 Kafka，然后 API 服务器读取该数据并更新/插入 MongoDB。

![](../tech-stack/assets/architecture-professional/004.png)

### 功能标志和指标跟踪数据流

功能标志和指标跟踪数据存储在 ClickHouse 中，用于 A/B/n 测试（实验）和报告。

当客户端/服务器 SDK 向评估服务器发送功能标志和指标跟踪消息时，评估服务器会将跟踪消息转发至 Kafka，数据分析服务器从 Kafka 读取跟踪消息并将其存储在 ClickHouse 中。

![](../tech-stack/assets/architecture-professional/005.png)

## **您是所有数据的唯一拥有者**

整体架构也确保了隐私保护，因为所有数据和通信都只在系统内部进行。我们不会将任何数据发送给第三方服务。您是所有数据的唯一拥有者，这也使我们可以自信地声称我们完全符合 [GDPR](https://gdpr-info.eu/) 标准。
