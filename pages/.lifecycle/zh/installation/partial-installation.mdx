
从 'nextra/components' 导入 { Callout }

# 部分安装

您可能已经在自己的基础架构中运行了 MongoDB、Redis、Kafka、Zookeeper 和/或 ClickHouse 服务，并且希望搭配自己的服务使用 FeatBit，这完全可行且易于操作。本文档将指导您如何使用 docker compose 实现此目的，同样也可轻松地迁移到 Kubernetes。

本文档将展示如何运行以下 FeatBit 服务：

* **UI :** 为用户提供一个视觉化的UI界面，用于管理和发布功能标志、细分市场和实验等。
* **API Server :** 为UI和外部集成服务提供数据管理能力，例如标志触发器、代码引用等。
* **评估服务器**：提供一个可扩展且高性能的标志规则评估引擎和数据分发服务。
* **数据分析服务器：** 提供数据分析引擎。它确保以下服务
  * 几乎实时计算实验并返回结果。
  * 为UI中的所有分析提供洞察服务，例如特性标记报告。

## 先决条件

* Docker（版本 20.10.7 或更高）
* Docker-Compose（版本 1.29.2 或更高）

<Callout type="info">
Windows users are recommended to use PowerShell for running commands below.
</Callout>


## 准备工作

* 克隆仓库

```bash
git clone https://github.com/featbit/featbit
cd featbit
```

* 如果您只是进行快速测试，我们已经创建了一个 **docker-compose-infra.yaml** 文件，您可以用它来安装 FeatBit 的基础服务（Redis、MongoDB、Kafka、Zookeeper 和 ClickHouse），以便顺利进行后续步骤。运行以下命令启动这些服务，如果您想使用自己的基础服务，请跳过这一步。

```sh
docker compose -f docker-compose-infra.yml up -d
```

* **如果您已经完成了上一步，请跳过这一步**。我们还创建了另一个 docker compose 文件**docker-compose-clickhouse.yml**，以便在您决定使用自己的基础架构但尚未安装 ClickHouse 的情况下，单独安装 ClickHouse。在这种情况下，请在以下路径设置 Zookeeper 配置：**featbit/infra/clickhouse/single\_node/config.xml**

```xml
<zookeeper>
    <node>
        <host>{your-zookeeper-host}</host>
        <port>{your-zookeeper-port}</port>
    </node>
</zookeeper>
```

然后运行以下命令：

```sh
docker compose -f docker-compose-clickhouse.yml up -d
```

*   在您喜欢的编辑器中打开 _**docker-compose-partial.yml**_，您会看到如下配置。假设基础服务（Redis、MongoDB、Kafka、ClickHouse）与我们在本文档中将安装的 FeatBit 服务处于同一网络中。

```yaml
ui:   
  image: featbit/featbit-ui:latest
  environment:
    - API_URL=[REPLACE_WITH_THE_API_SERVER_IP_OR_DOMAIN] # example: http://localhost:5000 
    - DEMO_URL=https://featbit-samples.vercel.app # keep it like this, this is for tutorial
    - EVALUATION_URL=[REPLACE_WITH_THE_EVALUATION_SERVER_IP_OR_DOMAIN] # example: http://localhost:5100 
  depends_on:
    - api-server
  ports:
    - "8081:80"
  networks:
    - featbit-network-service

api-server:
  image: featbit/featbit-api-server:latest
  environment:
      - MongoDb__ConnectionString=[REPLACE_WITH_MONGODB_CONNECTION_STRING] # example: mongodb://admin:password@mongodb:27017
      - MongoDb__Database=[REPLACE_WITH_MONGODB_NAME] # example featbit
      - Kafka__BootstrapServers=[REPLACE_WITH_KAFKA_CONNECTION_STRING] # example: 192.168.56.1:9092
      - OLAP__ServiceHost=[REPLACE_WITH_DA_SERVER_IP_OR_DOMAIN]:8200 # example: http://192.168.56.1:8200
  ports:
    - "5000:5000"
  networks:
    - featbit-network-service

evaluation-server:
  image: featbit/featbit-evaluation-server:latest
  environment:
      - MongoDb__ConnectionString=[REPLACE_WITH_MONGODB_CONNECTION_STRING] # same as api-server
      - MongoDb__Database=[REPLACE_WITH_MONGODB_NAME] # same as api-server
      - Kafka__BootstrapServers=[REPLACE_WITH_KAFKA_CONNECTION_STRING] # same as api-server
      - Redis__ConnectionString=[REPLACE_WITH_REDIS_CONNECTION_STRING] # example: http://192.168.56.1:6379
  ports:
    - "5100:5100"
  networks:
    - featbit-network-service

da-server:
  image: featbit/featbit-data-analytics-server:latest
  ports:
    - "8200:80"
  networks:
    - featbit-network-service
  environment:
    KAFKA_HOSTS: [REPLACE_WITH_KAFKA_CONNECTION_STRING] # example: kafka:9092
    REDIS_HOST: [REPLACE_WITH_REDIS_IP_OR_DOMAIN] # example: redis
    REDIS_PORT: [REPLACE_WITH_REDIS_PORT] # example: 6379
    CLICKHOUSE_HOST: [REPLACE_WITH_CLICKHOUSE_DB_HOST_IP_OR_DOMAIN] # example clickhouse-server
    CLICKHOUSE_KAFKA_HOSTS: [REPLACE_WITH_KAFKA_CONNECTION_STRING] # example kafka:9092
    # the following env variables are security related, they are optional
    # if any redis pwd
    REDIS_PASSWORD: [REPLACE_WITH_REDIS_PWD]
    KAFKA_SECURITY_PROTOCOL: [REPLACE_WITH_KAFKA_SECURITY_PROTOCOL] # one of PLAINTEXT, SASL_PLAINTEXT, SASL_SSL, SSL
    # if kafka security protocol is in SASL_PLAINTEXT, SASL_SSL, set the following 3 variables
    # KAFKA_SASL_MECHANISM: [REPLACE_WITH_KAFKA_SASL_MECHANISM]
    # KAFKA_SASL_USER: [REPLACE_WITH_KAFKA_SASL_USER]
    # KAFKA_SASL_PASSWORD: [REPLACE_WITH_KAFKA_SASL_PASSWORD]

networks:
  featbit-network-service:
    name: featbit-network
    external: true
```

## 数据植入

### Kafka 主题

您需要在您的 Kafka 中创建以下主题：

* featbit-feature-flag-change
* featbit-segment-change
* featbit-insights
* featbit-endusers

### MongoDB

我们提供了一个 [mongodb-seed-script](https://github.com/featbit/featbit/blob/main/infra/mongodb/docker-entrypoint-initdb.d/init.js) 来初始化我们的 MongoDB 数据库。该脚本假设数据库名称为 "featbit"（您可以更改），应与 MongoDb\_\_Database 环境变量相同。

您可以使用以下命令或其他工具执行种子脚本。

```sh
mongo < init.js
# or mongosh < init.js
```

## 安装

*   完成对 docker compose 文件的修改后，运行以下命令：
```bash
docker compose -f docker-compose-partial.yml up -d
```
* 所有容器启动后，访问 FeatBit的门户网站 [http://localhost:8081](http://localhost:8081/) 并使用默认凭据登录。
  * 用户名： **test@featbit.com**
  * 密码：**123456**

## 更新

执行以下命令，将 FeatBit 镜像更新至最新版本：

```bash
docker-compose pull
docker-compose rm -fsv featbit
docker-compose up -d
```

## 常见问题解答

* [如何解决 Docker 容器端口冲突问题?](faq.md#how-to-solve-docker-container-port-conflict-problem)
* [如何让 FeatBit 门户能够公开访问？](faq.md#how-to-make-featbit-portal-accessible-publicly)
