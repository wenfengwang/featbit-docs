import { Callout } from 'nextra/components'

# 部分安装

您可能已经在自己的基础架构中运行了 MongoDB、Redis、Kafka、Zookeeper 和/或 ClickHouse 服务，并且希望使用自己的服务运行 FeatBit，这是完全可能且易于做到的。本文档将说明如何使用 Docker Compose 来实现这一点，而且也可以很容易地转换为 Kubernetes。

本文档将向您展示如何运行以下 FeatBit 服务：

* **UI：** 为用户提供可视化的 UI 界面，用于管理和发布功能标志、区段和实验等。
* **API 服务器：** 为 UI 和外部集成服务提供数据管理功能，例如标志触发器、代码引用等。
* **评估服务器：** 提供可扩展且高性能的标志规则评估引擎和数据分发服务器。
* **数据分析服务器：** 提供数据分析引擎。它保证以下服务
  * 计算实验并几乎实时地返回其结果。
  * 为 UI 中的所有分析提供见解服务，例如功能标志报告。

## 先决条件

* Docker（版本 20.10.7 或更高版本）
* Docker-Compose（版本 1.29.2 或更高版本）

<Callout type="info">
建议 Windows 用户使用 PowerShell 运行以下命令。
</Callout>

## 准备工作

* 克隆存储库

```bash
git clone https://github.com/featbit/featbit
cd featbit
```

* 如果您只是进行快速测试，我们创建了一个名为 **docker-compose-infra.yaml** 的文件，您可以使用它来安装 FeatBit 的基础设施服务（Redis、MongoDB、Kafka、Zookeeper 和 ClickHouse），这样接下来的步骤就可以顺利进行。 运行以下命令以启动这些服务，如果您想使用自己的基础架构服务，请跳过此步骤。

```sh
docker compose -f docker-compose-infra.yml up -d
```

* **如果您已经运行了上一步，请跳过此步骤**。我们还创建了另一个名为 **docker-compose-clickhouse.yml** 的 docker compose 文件，用于仅安装 ClickHouse，以防您决定使用自己的基础架构但没有 ClickHouse。在这种情况下，请在以下路径中设置 Zookeeper 配置：**featbit/infra/clickhouse/single\_node/config.xml** 

```xml
<zookeeper>
    <node>
        <host>{your-zookeeper-host}</host>
        <port>{your-zookeeper-port}</port>
    </node>
</zookeeper>
```

然后运行以下命令

```sh
docker compose -f docker-compose-clickhouse.yml up -d
```

*   在您喜欢的编辑器中打开 _**docker-compose-partial.yml**_，您会看到以下配置。假设基础设施服务（Redis、MongoDB、Kafka、ClickHouse）与本文档中将安装的 FeatBit 服务运行在同一个网络中。
    &#x20;  &#x20;

```yaml
ui:   
  image: featbit/featbit-ui:latest
  environment:
    - API_URL=[REPLACE_WITH_THE_API_SERVER_IP_OR_DOMAIN] # 例如：http://localhost:5000 
    - DEMO_URL=https://featbit-samples.vercel.app # 保持不变，这是用于教程的
    - EVALUATION_URL=[REPLACE_WITH_THE_EVALUATION_SERVER_IP_OR_DOMAIN] # 例如：http://localhost:5100 
  depends_on:
    - api-server
  ports:
    - "8081:80"
  networks:
    - featbit-network-service

api-server:
  image: featbit/featbit-api-server:latest
  environment:
      - MongoDb__ConnectionString=[REPLACE_WITH_MONGODB_CONNECTION_STRING] # 例如：mongodb://admin:password@mongodb:27017
      - MongoDb__Database=[REPLACE_WITH_MONGODB_NAME] # 例如 featbit
      - Kafka__BootstrapServers=[REPLACE_WITH_KAFKA_CONNECTION_STRING] # 例如：192.168.56.1:9092
      - OLAP__ServiceHost=[REPLACE_WITH_DA_SERVER_IP_OR_DOMAIN]:8200 # 例如：http://192.168.56.1:8200
  ports:
    - "5000:5000"
  networks:
    - featbit-network-service

evaluation-server:
  image: featbit/featbit-evaluation-server:latest
  environment:
      - MongoDb__ConnectionString=[REPLACE_WITH_MONGODB_CONNECTION_STRING] # 与 api-server 相同
      - MongoDb__Database=[REPLACE_WITH_MONGODB_NAME] # 与 api-server 相同
      - Kafka__BootstrapServers=[REPLACE_WITH_KAFKA_CONNECTION_STRING] # 与 api-server 相同
      - Redis__ConnectionString=[REPLACE_WITH_REDIS_CONNECTION_STRING] # 例如：http://192.168.56.1:6379
  ports:
    - "5100:5100"
  networks:
    - featbit-network-service

da-server:
  image: featbit/featbit-data-analytics-server:latest
  ports:
    - "8200:80"
  networks:
    - featbit-network-service
  environment:
    KAFKA_HOSTS: [REPLACE_WITH_KAFKA_CONNECTION_STRING] # 例如：kafka:9092
    REDIS_HOST: [REPLACE_WITH_REDIS_IP_OR_DOMAIN] # 例如：redis
    REDIS_PORT: [REPLACE_WITH_REDIS_PORT] # 例如：6379
    CLICKHOUSE_HOST: [REPLACE_WITH_CLICKHOUSE_DB_HOST_IP_OR_DOMAIN] # 例如 clickhouse-server
    CLICKHOUSE_KAFKA_HOSTS: [REPLACE_WITH_KAFKA_CONNECTION_STRING] # 例如 kafka:9092
    # 以下环境变量与安全相关，它们是可选的
    # 如果有任何 redis 密码
    REDIS_PASSWORD: [REPLACE_WITH_REDIS_PWD]
    KAFKA_SECURITY_PROTOCOL: [REPLACE_WITH_KAFKA_SECURITY_PROTOCOL] # 为 PLAINTEXT、SASL_PLAINTEXT、SASL_SSL、SSL 中的一个
    # 如果 Kafka 安全协议是 SASL_PLAINTEXT、SASL_SSL，则设置以下 3 个变量
    # KAFKA_SASL_MECHANISM: [REPLACE_WITH_KAFKA_SASL_MECHANISM]
    # KAFKA_SASL_USER: [REPLACE_WITH_KAFKA_SASL_USER]
    # KAFKA_SASL_PASSWORD: [REPLACE_WITH_KAFKA_SASL_PASSWORD]

networks:
  featbit-network-service:
    name: featbit-network
    external: true
```

## 数据种子填充

### Kafka 主题

您需要在 Kafka 中创建以下主题：

* featbit-feature-flag-change
* featbit-segment-change
* featbit-insights
* featbit-endusers

### MongoDB

我们提供了一个 [mongodb-seed-script](https://github.com/featbit/featbit/blob/main/infra/mongodb/docker-entrypoint-initdb.d/init.js) 来为我们的 MongoDB 数据库提供种子数据。此脚本假定数据库名称为 "featbit"（您可以更改它），它应该与 MongoDb\_\_Database 环境变量相同。

您可以使用以下命令或任何其他工具运行种子脚本。

```sh
mongo < init.js
# 或者使用 mongosh < init.js
```

## 安装

* 修改完 Docker Compose 文件后，运行以下命令
```bash
docker compose -f docker-compose-partial.yml up -d
```
* 所有容器启动后，转到 FeatBit 的门户 [http://localhost:8081](http://localhost:8081/) 并使用默认凭据登录。
  * 用户名：**test@featbit.com**
  * 密码：**123456**

## 更新

运行以下命令以更新到最新的 FeatBit 映像：

```bash
docker-compose pull
docker-compose rm -fsv featbit
docker-compose up -d
```

## 常见问题

* [如何解决 Docker 容器端口冲突问题？](faq.md#how-to-solve-docker-container-port-conflict-problem)
* [如何使 FeatBit 门户可以公开访问？](faq.md#how-to-make-featbit-portal-accessible-publicly)
