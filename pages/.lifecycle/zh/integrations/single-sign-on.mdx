import {Callout} from 'nextra/components'

# 单点登录

<Callout type="info">本文兼容 FeatBit 3.0.0 及以上版本。</Callout>

<Callout type="info">
    单点登录功能仅适用于企业订阅的客户。有关详细信息，请查看 [FeatBit 计划](https://dashboard.featbit.co/en)。您也可以使用试用许可证试用此功能，试用许可证可以在此处生成 [Featbit 仪表板](https://dashboard.featbit.co/account)。
</Callout>

SSO 可通过 OpenID Connect 在 FeatBit 自托管版本上使用。要在自托管的 FeatBit 实例上启用 SSO，您需要一个有效的许可证密钥，然后可以为您的提供商添加 SSO 设置。

## SSO 设置

若要启用 SSO，您需要添加以下设置：

### 为 FeatBit Api 服务添加环境变量

- `SSOEnabled`：设置为 `true` 以启用 SSO。

### 通过 UI 添加 OpenID Connect 设置

FeatBit 成功启动后，转到 UI **http://localhost:8081/workspace** 并添加以下设置：

- `clientId`：OIDC 客户端 ID。
- `clientSecret`：OIDC 客户端密钥。
- `redirectUri`：OIDC 重定向 URI。
- `tokenEndpoint`：OIDC 令牌端点。
- `clientAuthenticationMethod`：OIDC 客户端认证方法。通常设置为 `client_secret_post`，我们也支持 `client_secret_basic`。
- `authorizationEndpoint`：OIDC 授权端点。
- `scope`：要请求的 OIDC 范围。通常设置为 `openid profile email`。
- `userEmailClaim`：OIDC 用户电子邮件声明。如果使用上述范围，通常设置为 `email`。

## 示例

我们已经测试了 **Keycloak**、**Okta** 和 **Auth0** 的 FeatBit SSO。以下是使用 Keycloak 为例的分步指南。

### 1. 运行 Keycloak
从 Docker 运行 Keycloak 并使用 `admin`/`admin` 在 [localhost:9000](http://localhost:9000) 登录管理控制台

```bash
docker run -d -p 9000:8080 -e KEYCLOAK_ADMIN=admin -e KEYCLOAK_ADMIN_PASSWORD=admin --name=keycloak quay.io/keycloak/keycloak:22.0.1 start-dev
```

### 2. 创建领域

创建一个名为 `featbit` 的新领域并切换到该领域

![](../integrations/assets/single-sign-on/create-realm.png)

### 3. 创建 OIDC 客户端

使用以下设置创建 OIDC 客户端，这里有一些重要设置：
- 将客户端的有效重定向 URI 设置为 http://localhost:8081/*（FeatBit UI 服务地址）
- 将客户端的 Web Origins 设置为 http://localhost:8081/*（FeatBit UI 服务地址）
- 启用客户端认证

![](../integrations/assets/single-sign-on/client-settings.png)

### 4. 创建用户
在 KeyCloak 上创建一个用户，并为该用户设置密码

### 5. 启动 FeatBit

在 `docker-compose.yml` 中为 FeatBit Api 服务设置以下环境变量：

```yaml
SSOEnabled=true
```

启动 FeatBit，您应该能够在登录页面上看到 SSO 选项卡。
```bash
cd featbit
docker-compose up -d
```
![](../integrations/assets/single-sign-on/sso-login.png)

然后点击 `Login` 选项卡并使用默认凭据 `test@featbit.com`/`123456` 登录

### 6. 配置 OIDC 设置

转到 **http://localhost:8081/workspace** 并添加您的 OpenID Connect 设置，然后点击 **Update**，请 **将客户端密钥替换** 为您自己的值

![](../integrations/assets/single-sign-on/oidc-settings.png)

### 7. 使用 SSO 登录

在 **General settings** 中复制工作区密钥，使用 SSO 登录时将需要它

![](../integrations/assets/single-sign-on/ws-key.png)

登出并点击 SSO，使用之前复制的工作区密钥。
点击 **Continue**，浏览器应将您带到 Keycloak 登录页面，然后您可以使用之前创建的用户登录。

