import {Callout} from 'nextra/components'

# 单点登录

<Callout type="info">
    本文章适用于 FeatBit 3.0.0 及以上版本。
</Callout>

<Callout type="info">
    单点登录功能仅在企业订阅版中可用。了解更多详情，请查看[FeatBit 计划](https://dashboard.featbit.co/en)。您也可以使用试用许可证来尝试该功能，试用许可证可以在[Featbit dashboard](https://dashboard.featbit.co/account)生成。
</Callout>

通过 OpenID Connect，可以在 FeatBit 自托管上使用单点登录。要在自托管的 FeatBit 实例上启用单点登录，您需要一个活动的许可证密钥，然后可以为您的提供程序添加单点登录设置。

## 单点登录设置

要启用单点登录，您需要添加以下设置：

### 为 FeatBit Api 服务添加环境变量

- `SSOEnabled`：将其设置为 `true` 以启用单点登录。

### 通过 UI 添加 OpenId Connect 设置

一旦 FeatBit 成功启动，访问 UI **http://localhost:8081/workspace** 并添加以下设置：

- `clientId`：OIDC 客户端 ID。
- `clientSecret`：OIDC 客户端密钥。
- `redirectUri`：OIDC 重定向 URI。
- `tokenEndpoint`：OIDC 令牌终结点。
- `clientAuthenticationMethod`：OIDC 客户端认证方法。大多数情况下设置为 `client_secret_post`，我们也支持 `client_secret_basic`。
- `authorizationEndpoint`：OIDC 授权终结点。
- `scope`：要请求的 OIDC 范围。大多数情况下设置为 `openid profile email`。
- `userEmailClaim`：OIDC 用户电子邮件声明。如果使用上述范围，请将其设置为 `email`。

## 示例

我们已经使用 **Keycloak、Okta 和 Auth0** 测试了 FeatBit 的单点登录。下面以使用 Keycloak 为例提供逐步指南。

### 1. 运行 Keycloak
使用 Docker 运行 Keycloak，并在[localhost:9000](http://localhost:9000)上使用 `admin`/`admin` 登录管理控制台。

```bash
docker run -d -p 9000:8080 -e KEYCLOAK_ADMIN=admin -e KEYCLOAK_ADMIN_PASSWORD=admin --name=keycloak quay.io/keycloak/keycloak:22.0.1 start-dev
```

### 2. 创建一个 Realm

创建一个名为 `featbit` 的新 Realm，并切换到该 Realm

![](../integrations/assets/single-sign-on/create-realm.png)

### 3. 创建一个 OIDC 客户端

使用以下设置创建一个 OIDC 客户端，以下是一些重要的设置：
- 将客户端的 Valid Redirect URIs 设置为 http://localhost:8081/*（FeatBit UI 服务地址）
- 将客户端的 Web Origins 设置为 http://localhost:8081/*（FeatBit UI 服务地址）
- 启用客户端认证

![](../integrations/assets/single-sign-on/client-settings.png)

### 4. 创建一个用户
在 KeyCloak 上创建一个用户，并为该用户设置密码

### 5. 启动 FeatBit

在 `docker-compose.yml` 中为 FeatBit Api 服务设置以下环境变量。

```yaml
SSOEnabled=true
```

启动 FeatBit，你应该能够在登录页面上看到 SSO 选项卡。
```bash
cd featbit
docker-compose up -d
```
![](../integrations/assets/single-sign-on/sso-login.png)

然后点击 `Login` 选项卡，并使用默认凭据 `test@featbit.com`/`123456` 登录

### 6. 配置 OIDC 设置

转到 **http://localhost:8081/workspace** 并添加您的 OpenID Connect 设置，然后点击 **Update**，请**用您自己的值替换客户端密钥**

![](../integrations/assets/single-sign-on/oidc-settings.png)

### 7. 使用 SSO 登录

复制 **General settings** 中的工作空间密钥，在使用 SSO 登录时需要它

![](../integrations/assets/single-sign-on/ws-key.png)

退出登录并点击 SSO，使用之前复制的工作空间密钥。
点击 **Continue**，浏览器将带您前往 Keycloak 登录页面，然后您可以使用之前创建的用户进行登录。
