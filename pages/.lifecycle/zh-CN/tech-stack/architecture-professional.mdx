import { Callout } from 'nextra/components'

# 架构 - 专业版

<Callout type="info" >
此文档适用于专业版，请参考[架构](architecture.md)[ ](architecture.md)以查看标准版。要了解标准版和专业版之间的区别，请查看[标准版 VS 专业版](standard-vs.-professional.md)。
</Callout>

## **概述**

FeatBit是一个可扩展且高效的特性管理平台。FeatBit的使命是授权所有团队交付、控制、进行试验和变现其软件。

总体架构如下：

![](../tech-stack/assets/architecture-professional/001.png)

* **UI：**为用户提供可视化的界面，用于管理和发布特性标志、分段和实验等。
* **API服务器：**为UI和外部集成服务（如标志触发器、代码引用等）提供数据管理功能。
* **评估服务器：**提供可扩展和高性能的标志规则评估引擎和数据分发服务器。
* **数据分析服务器：**提供数据分析引擎，确保以下服务
  * 实时计算实验并返回结果。
  * 为UI提供洞察服务，例如特性标志报告。
* **SDK：**我们为所有主要语言和框架提供SDK，为您的服务和应用程序提供快速访问FeatBit的能力。
* **Redis：**缓存层以提高性能。
* **Kafka：**消息队列，确保不同服务之间的高吞吐量异步数据通信。它不仅提高了整体性能，还解耦了服务。
* **MongoDB：**主要数据库。所有特性标志、分段、实验和最终用户数据都存储在MongoDB中。
* **ClickHouse：**用于分析服务的数据库。您可以在其中找到所有特性调用和指标调用日志。

## 可扩展和高性能

在设计架构时，我们最重要和唯一的关注点是如何使其可扩展，并获得最佳性能。为此，我们精心选择了我们的技术栈，并将所有服务容器化，这使得它非常容易作为一个集群来部署和**横向扩展**。

至于数据存储和服务之间的数据流动，在为了获得最佳性能的同时，我们选择了MongoDB作为我们的主要数据存储，Redis作为系统缓存，Kafka作为消息队列，ClickHouse作为分析和A/B/n测试数据存储等。我们使用**多路复用**和**发布订阅系统**在服务之间发送/接收消息，平均响应时间为毫秒级。

特性标志更改或其他配置向SDK推送的时间几乎是实时的。当从UI更改标志时，将数据推送到SDK的时间不超过**100**毫秒。我们采用WebSocket解决方案，而不是长轮询，因为它可以在发生变化时主动推送更改给SDK。当然，这并不是免费的，当有大量并发请求发生时，它可能会消耗大量内存。为了避免成为内存怪兽，我们精心选择了序列化和反序列化数据的方式，以确保在序列化和反序列化过程中不会消耗额外内存。

## 数据流

系统运行时，数据在不同服务之间流动。主要有四个主要的数据流动：

### 数据同步（特性标志/分段）数据流

特性标志/分段数据存储在MongoDB中，它是FeatBit的所有主要功能的核心数据存储。

在客户端或服务器SDK与评估服务器建立连接后，SDK将发送一个附带有最新更改时间戳的数据同步请求给评估服务器。评估服务器会检查该时间戳，并从Redis中获取符合条件的特性标志和分段。经过评估过程（仅适用于客户端SDK），结果将被发送回SDK。响应有两种类型：

* **full**：响应包含所有特性标志和分段
* **patch**：响应仅包含自时间戳以来创建或更新的新特性标志和分段

![](../tech-stack/assets/architecture-professional/002.png)

### 特性标志/分段更改流

当用户从UI更改特性标志或分段时，除了在MongoDB中存储数据外，API服务器还会将更改推送到Kafka，评估服务器读取这些更改，更新Redis，评估与更改相关的特性标志，并通过WebSocket连接将相关特性标志或评估结果发送给客户端/服务器端SDK。

![](../tech-stack/assets/architecture-professional/003.png)

### 最终用户数据流

最终用户数据存储在MongoDB中，用于特性标志和分段定位。

当客户端SDK建立WebSocket连接或切换到另一个用户（通过调用identify API），或客户端/服务器SDK发送跟踪消息时，评估服务器将最终用户信息发送到Kafka，然后API服务器读取该数据并更新/插入MongoDB。

![](../tech-stack/assets/architecture-professional/004.png)

### 特性标志和指标跟踪数据流

特性标志和指标跟踪数据存储在ClickHouse中，用于A/B/n测试（实验）和报告。

当客户端/服务器SDK将特性标志和指标跟踪消息发送到评估服务器时，后者将跟踪消息转发到Kafka，数据分析服务器从Kafka读取跟踪消息并将其存储在ClickHouse中。

![](../tech-stack/assets/architecture-professional/005.png)

## **您是所有数据的唯一所有者**

整体架构还确保了隐私方面，因为所有的数据和通信都在系统内部。它不会将任何数据发送给任何第三方服务。您是所有数据的唯一所有者，这也使我们可以自信地声明我们完全符合 [GDPR](https://gdpr-info.eu/) 的规定。