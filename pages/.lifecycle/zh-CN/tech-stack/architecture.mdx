import { Callout } from 'nextra/components'

# 架构


<Callout type="info" >
  此文档适用于标准版，请参考[架构-专业版](architecture-professional.md)来了解专业版。如需了解标准版和专业版的差异，请查看[标准版VS专业版](standard-vs.-professional.md)。
</Callout>

## **概述**

FeatBit是一个可扩展且快速的功能管理平台。FeatBit的使命是赋能所有团队交付、控制、试验和实现软件的能力。

总体架构如下所示:

![](../tech-stack/assets/architecture/001.webp)

* **UI：** 为用户提供一个可视化的界面，用于管理和发布功能标志、段和实验等。
* **API 服务器：** 为UI和外部集成服务提供数据管理能力，例如标志触发器、代码引用等。
* **评估服务器：** 提供可扩展和高性能的标志规则评估引擎和数据分发服务器。
* **数据分析服务器：** 提供数据分析引擎。它提供以下服务
  * 实时计算实验结果。
  * 为UI提供洞察服务，例如功能标志报告。
* **SDK：** 我们为所有主要语言和框架提供SDK，以便从您的服务和应用程序快速访问FeatBit。
* **Redis：** 具有两个角色
  * 缓存层以提升性能。
  * 作为不同服务之间高吞吐异步数据通信的消息队列。
* **MongoDB：** 主要数据库。所有功能标志、段、实验、终端用户和分析数据都存储在MongoDB中。

## 可扩展且高性能

在设计架构时，我们最重要且唯一的关注点是如何使其可扩展并获得最佳性能。为此，我们精选了我们的技术栈，并将所有服务容器化，使其非常易于作为集群部署并进行**横向扩展**。

至于数据存储和服务之间的数据流动，在为了获得最佳性能时，我们引入了MongoDB作为我们的主要数据存储，Redis作为系统缓存和消息队列。我们使用**多路复用**和**发布-订阅系统**在服务之间发送/接收消息，平均响应时间在毫秒级。

功能标志的更改或其他配置向SDK推送是准实时的。当从UI更改标志时，将数据推送到SDK的时间不超过**100**毫秒。我们采用了WebSocket解决方案，而不是使用长轮询，因为它可以在发生更改时主动推送更改给SDK。当然，这并非没有成本，在大量并发请求发生时，可能会占用大量内存。为了避免成为内存占用巨兽，我们经过精心选择的序列化和反序列化数据的方式，以便在序列化和反序列化过程中不消耗额外的内存。

## 数据流动

系统运行时，数据在不同服务之间流动。主要有四种主要的数据流动方式：

### 数据同步（功能标志/段）数据流

功能标志/段数据存储在MongoDB中，它是FeatBit的所有重要功能的数据存储。

在客户端或服务器SDK与评估服务器建立连接之后，SDK会发送一个附加有最新更改时间戳的数据同步请求到评估服务器，评估服务器会检查该时间戳并从Redis中获取符合条件的功能标志和段，经过评估过程（仅适用于客户端SDK），将结果发送回SDK。响应有两种类型之一：

* **full**：响应包含所有功能标志和段
* **patch**：响应仅包含自时间戳以来创建或更新的新功能标志和段

![](../tech-stack/assets/architecture/002.png)

### 功能标志/段更改数据流

当用户从UI更改功能标志或段时，除了将数据存储在MongoDB中，API服务器还将更改推送到Kafka，评估服务器读取这些更改，更新Redis，评估与更改相关的功能标志，并通过WebSocket连接将相关功能标志或评估结果发送给客户端/服务器端SDK。

![](../tech-stack/assets/architecture/003.png)

### 终端用户数据流

终端用户数据存储在MongoDB中，作为功能标志和段的定向。

当客户端SDK建立WebSocket连接或切换到另一个用户（通过调用标识API），或客户端/服务器SDK发送跟踪消息时，评估服务器将终端用户信息发送到Kafka，然后API服务器读取该数据并更新/插入MongoDB。

![](../tech-stack/assets/architecture/004.png)

### 功能标志和度量跟踪数据流

功能标志和度量跟踪数据存储在ClickHouse中，用于A/B/n测试（试验）和报告。

当客户端/服务器SDK向评估服务器发送功能标志和度量跟踪消息时，评估服务器将跟踪消息转发到Kafka，数据分析服务器从Kafka中读取跟踪消息并将其存储在ClickHouse中。

![](../tech-stack/assets/architecture/005.png)

## **您是所有数据的唯一所有者**

总体架构还确保了隐私方面的问题，因为所有数据和通信都在系统内部。它不会向任何第三方服务发送任何数据。您是所有数据的唯一所有者，这也使我们能够自信地宣称我们完全符合[GDPR](https://gdpr-info.eu/)的规定。