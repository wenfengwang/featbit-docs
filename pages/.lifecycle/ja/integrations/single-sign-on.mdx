import { Callout } from 'nextra/components'

# シングルサインオン

<Callout type="info">
    この記事は FeatBit 3.0.0 以降と互換性があります。
</Callout>

<Callout type="info">
    シングルサインオン機能はエンタープライズサブスクリプションのお客様のみご利用いただけます。詳細については [FeatBitプラン](https://dashboard.featbit.co/en) をご確認ください。また、トライアルライセンスでこの機能をお試しいただけます。トライアルライセンスはこちらから生成できます [Featbit ダッシュボード](https://dashboard.featbit.co/account)。
</Callout>

FeatBit Self-hostedでは、OpenID Connectを介してSSOを利用することができます。SSOを有効にするためには、アクティブなライセンスキーが必要であり、その後、プロバイダーのためのSSO設定を追加することができます。

## SSOの設定

SSOを有効にするには、以下の設定を追加する必要があります

### FeatBit Apiサービスの環境変数を追加する

- `SSOEnabled`： SSOを有効にする場合は `true` に設定します。

### UIを介してOpenId Connectの設定を追加する

FeatBitが正常に起動したら、以下の設定を追加するためにUI **http://localhost:8081/workspace** に移動してください。

- `clientId`：OIDCクライアントID。
- `clientSecret`：OIDCクライアントシークレット。
- `redirectUri`：OIDCリダイレクトURI。
- `tokenEndpoint`：OIDCトークンエンドポイント。
- `clientAuthenticationMethod`：OIDCクライアント認証方法。大抵は`client_secret_post`に設定されますが、`client_secret_basic`もサポートしています。
- `authorizationEndpoint`：OIDC認可エンドポイント。
- `scope`：リクエストするOIDCスコープ。大抵は `openid profile email`に設定されます。
- `userEmailClaim`：OIDCユーザーのメールクレーム。上記のスコープを使用する場合は `email` に設定します。

## 例

FeatBit SSOを**Keycloak、Okta、およびAuth0**でテストしました。以下はKeycloakを使用した手順です。

### 1. Keycloakを実行する
DockerからKeycloakを実行し、管理コンソールに `admin` / `admin` でログインします [localhost:9000](http://localhost:9000)

```bash
docker run -d -p 9000:8080 -e KEYCLOAK_ADMIN=admin -e KEYCLOAK_ADMIN_PASSWORD=admin --name=keycloak quay.io/keycloak/keycloak:22.0.1 start-dev
```

### 2. レルムの作成

`featbit` という新しいレルムを作成し、そのレルムに切り替えます

![](../integrations/assets/single-sign-on/create-realm.png)

### 3. OIDCクライアントの作成

次の設定でOIDCクライアントを作成します。いくつか重要な設定は次のとおりです：
- クライアントの `有効なリダイレクトURIs` を http://localhost:8081/* (FeatBit UI サービスアドレス)に設定します。
- クライアントの `Web Origins` を http://localhost:8081/* (FeatBit UI サービスアドレス)に設定します。
- クライアント認証を有効にします

![](../integrations/assets/single-sign-on/client-settings.png)

### 4. ユーザーの作成
KeyCloakでユーザーを作成し、そのユーザーにパスワードを設定します。

### 5. FeatBitを起動する

`docker-compose.yml`のFeatBit Apiサービスのために、以下の環境変数を設定します。

```yaml
SSOEnabled=true
```

FeatBitを起動し、ログインページでSSOタブを表示できるはずです。
```bash
cd featbit
docker-compose up -d
```
![](../integrations/assets/single-sign-on/sso-login.png)

次に、`Login` タブをクリックし、デフォルトの資格情報 `test@featbit.com` / `123456` でログインします。

### 6. OIDC設定の構成

**http://localhost:8081/workspace** に移動し、OpenID Connectの設定を追加し、**更新** をクリックします。クライアントシークレットは独自の値に置き換えてください。

![](../integrations/assets/single-sign-on/oidc-settings.png)

### 7. SSOでログインする

**一般設定** からワークスペースキーをコピーし、SSOでログインする際に必要です。

![](../integrations/assets/single-sign-on/ws-key.png)

ログアウトし、SSOをクリックして、以前にコピーしたワークスペースキーを使用します。
**続行** をクリックすると、ブラウザがKeycloakのログインページに移動し、事前に作成したユーザーでログインできます。