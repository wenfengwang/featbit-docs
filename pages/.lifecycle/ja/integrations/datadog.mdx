import { Callout } from 'nextra/components'

# DataDog

FeatBitは、DataDogとの統合に以下の方法を提供しています：

1. [Datadog RUMインテグレーションを使用して](https://docs.datadoghq.com/real_user_monitoring/guide/setup-feature-flag-data-collection/?tab=browser#analyze-your-feature-flag-performance-in-rum)、機能フラグの評価データをDataDogに送信します。
2. [Datadogイベントインテグレーションを使用して](https://docs.datadoghq.com/api/?lang=bash#events)、FeatBitからの機能フラグ更新などのアクティビティを受信します。
3. DataDogメトリックが特定の閾値を下回った場合に機能フラグをロールバックするためのフラグトリガーを使用します。
4. 機能フラグのインサイトをDataDog APMにエクスポートします。

## Datadog RUMインテグレーションの使用

[機能フラグトラッキング](https://docs.datadoghq.com/real_user_monitoring/feature_flag_tracking/)により、特定の機能が表示されているユーザーや、導入した変更がユーザーエクスペリエンスやパフォーマンスにどのような影響を与えているかを判断することができ、ユーザーエクスペリエンスとパフォーマンスモニタリングをより詳細に把握できます。

### 機能フラグデータ収集のセットアップ

始めるには、[DataDog機能フラグデータ収集をセットアップ](https://docs.datadoghq.com/real_user_monitoring/guide/setup-feature-flag-data-collection)する必要があります。**JavaScript/TypeScript**プロジェクトの場合、RUM SDKを初期化し、`enableExperimentalFeatures`初期化パラメーターに`["feature_flags"]`を設定する必要があります。これにより、機能フラグトラッキング機能が有効になり、機能フラグの評価データがDataDogに送信されます。

```javascript
datadogRum.init({
  applicationId: "sample-application-id",
  clientToken: "sample-client-token",
  site: "datadoghq.com",
  service: "demo-app",
  env: "dev",
  version: "1.0.0",
  sessionSampleRate: 100,
  sessionReplaySampleRate: 100,
  trackUserInteractions: true,
  trackResources: true,
  trackLongTasks: true,
  defaultPrivacyLevel: "mask-user-input",
  // これによりベータ版の機能フラグトラッキングが有効になります
  enableExperimentalFeatures: ["feature_flags"]
});

datadogRum.startSessionReplayRecording();
```

その後、FeatBitの機能フラグを評価する際に、datadogRumパッケージに組み込まれている`addFeatureFlagEvaluation`メソッドを使用できます。

```javascript
import { datadogRum } from "@datadog/browser-rum";
import fbClient from "featbit-js-client-sdk";

const flagEvalResult = fbClient.variation("feature-flag-key", flagsDefaultValues[prop] || '')
datadogRum.addFeatureFlagEvaluation("feature-flag-key", flagEvalResult);
```

どこでも2行のコードを書きたくない場合、`.variation(...)`と`.addFeatureFlagEvaluation(...)`を関数にカプセル化することができます。私たちの[Reactサンプル](https://github.com/featbit/featbit-samples/blob/main/samples/dino-game/interactive-demo-react/src/featBit/featBitSlice.js)と[Vueサンプル](https://github.com/featbit/featbit-samples/blob/main/samples/dino-game/interactive-demo-vue/src/featbit.js)プロジェクトでは、機能フラグの値を取得するための統一されたインターフェースを提供する`Flags Proxy`を作成しました。そのため、Flags ProxyにaddFeatureFlagEvaluationを追加して、以下のように使用できます：

```javascript
import { datadogRum } from "@datadog/browser-rum";
import fbClient from "featbit-js-client-sdk";

export const createFlagsProxy = () => {
    return new Proxy({}, {
        get(target, prop, _) {
          let returnValue = ''
          if(typeof prop === 'string' && !prop.startsWith('__v_')){
            returnValue = fbClient.variation(prop, flagsDefaultValues[prop] || '');
            datadogRum.addFeatureFlagEvaluation(prop, returnValue);
          }
          return returnValue;
        }
    })
}
```

コード内で機能フラグを呼び出すと、以下のコードに示すように、自動的に機能フラグの評価データがDataDogに送信されます。

```javascript
// VueのPiniaを使用した例、以下のコードは機能フラグ値のリアルタイム更新も保証します
<DinoGameCore v-if="featBitStore.flags['game-runner'] == true"
              :difficulty="featBitStore.flags['difficulty-mode']" />

// Reduxを使用したReactの例、以下のコードは機能フラグ値のリアルタイム更新も保証します
featureFlags["game-runner"] == true ? 
  <DinoGameCore difficulty={featureFlags["difficulty-mode"]} /> : <>

```


<Callout type="info">
**注記**: 上記のチュートリアルでは、ブラウザで機能フラグ評価データを収集する方法を示しました。iOSやAndroidなどの他のプラットフォームについては、[DataDogドキュメント](https://docs.datadoghq.com/real_user_monitoring/guide/setup-feature-flag-data-collection/?tab=ios#custom-feature-flag-management)を参照してください。
</Callout>


### RUMおよびAPMで機能フラグのパフォーマンスを分析する

FeatBitをDataDogと統合したら、[RUMで機能フラグのパフォーマンスを分析することができます](https://docs.datadoghq.com/real_user_monitoring/guide/setup-feature-flag-data-collection/?tab=browser#analyze-your-feature-flag-performance-in-rum)。DataDogのRUMダッシュボードを使用して、**セッション**、**ビュー**、**エラー**をフィルタリングできます。例えば、FeatBitが評価されたビューで、指定された時間枠内に発生した全てのエラーを、下図に示すように見つけることができます。

![](../integrations/assets/datadog/filter-errors-with-feature-flag-in-rum.webp)

機能フラグを表示および分析するには、[DataDog Feature Flags Tracking チュートリアルを参照してください](https://docs.datadoghq.com/real_user_monitoring/feature_flag_tracking/#view-your-feature-flags)。

[DataDog APM](https://www.datadoghq.com/product/apm/) を使用している場合、DataDog はフロントエンドの機能フラグデータをトレースに接続する方法を提供します。[Connect RUM and Traces](https://docs.datadoghq.com/real_user_monitoring/connect_rum_and_traces/?tab=browserrum) を参照してください。これにより、フロントエンドとバックエンドの両方のエラーに基づいてアラートを設定できます。

## Datadog イベントインテグレーションの使用

Datadog インテグレーションにより、[Datadog Events](https://docs.datadoghq.com/api) を設定して FeatBit からのアクティビティを受け取ることができます。機能フラグの更新や新しいアカウントメンバーの FeatBit への追加など、何か変更が発生すると、FeatBit は Datadog にイベントを送信します。この統合を使用して、FeatBit の機能変更がアプリケーションとインフラストラクチャのメトリクスにどのように影響するかを相関させて理解できます。

以下の画像は、機能フラグイベントとサービス APM ダッシュボードの障害検出との間に発見された相関関係を示しています。機能フラグをオフにした後、障害は解消されました。

![](../integrations/assets/datadog/dashboard-apm-error-turn-off-events.png)

イベントの完全な統合はまだ作業中です。しかし、現在は MongoDB `AuditLogs` コレクションのイベント変更を監視するためのプログラムを自分で書くことができます。こちらは [.NET でコレクションの変更を監視する方法の公式チュートリアル](https://mongodb.github.io/mongo-csharp-driver/2.7/reference/driver/change_streams/) です。

![](../integrations/assets/datadog/mongodb-auditlog-collection.png)

その後、[DataDog Events API](https://docs.datadoghq.com/api/latest/events/#post-an-event) を使用してアクティビティを DataDog に送信できます。

<Callout type="info" emoji='💡'>
この実装に関する機能開発を加速してほしい場合は、お知らせください。
</Callout>


## Datadog でのフラグトリガーの使用

[DataDog Webhook](https://docs.datadoghq.com/integrations/webhooks/) を使用すると、メトリックアラートがトリガーされた際にサービスに通知することができます。Webhook の設定で、[FeatBit Flag Trigger](../feature-flags/feature-workflow/flag-triggers) を直接呼び出して機能フラグをオン/オフに切り替えるか、特定のユーザーグループに対して [FeatBit REST API](../api-docs/using-featbit-rest-api) のロールアウト/ロールバックを呼び出すことができます。Webhook で Flag Trigger を呼び出す設定方法は以下の通りです：

1. まず、Feature Flags で Flag Trigger を作成します。[Workflow/Flag Triggers](/feature-flags/feature-workflow/flag-triggers) を参照してください。

![](../integrations/assets/datadog/flag-trigger.png)

2. DataDog インテグレーションで新しい Webhook を作成し、新しい Webhook に Flag Trigger の URL をコピーします。

![](../integrations/assets/datadog/create-webhook.png)

3. Monitor ページに移動し、検索クエリと条件を用いてメトリックを作成します。その後、アラートのテキストに `@webhook-name_of_the_webhook` を追加します。条件で設定されたしきい値をメトリックが下回った場合、Webhook がトリガーされます。

![](../integrations/assets/datadog/monitor-notify-team.png)

4. Webhook がトリガーされると、機能フラグは自動的にオン/オフに切り替わります。

## DataDog APM への Feature Flags Insights のエクスポート

Datadog は、アプリケーションやシステムのパフォーマンスと動作を監視するための様々なツールや機能を提供しています。**メトリクス**を使用して、環境の健康状態を一目で評価できます。例えば、ユーザーがウェブサイトをどれくらい速くロードしているか、サーバーの平均メモリ消費量などを視覚化できます。問題を特定したら、**ログ**と**トレーシング**を使用してさらにトラブルシューティングを行います。

上記のように APM にアクティビティイベントを送信することに加えて（[Datadog イベントインテグレーションの使用](#using-the-datadog-events-integration)）、Pro バージョンでは **ClickHouse** を介して、また標準バージョンでは **MongoDB** を介して、FeatBit のフィーチャーフラグインサイトデータ（フロントエンドとバックエンドの両方のフィーチャーフラグ使用データ）およびカスタムイベントデータを Datadog にエクスポートすることで、Datadog APM およびメトリクスと深く統合できます。次に、フラグ使用の概要（カウント、高レベルの影響）を示す**メトリクス**を選択したり、フラグが個々のリクエストにどのように影響を与えるかを深く理解するための**トレース**を選択できます。メトリクスとトレースを両方使用することで、フィーチャーフラグの動作とアプリケーションのパフォーマンスに関する包括的なビューを提供できます。

**この実装に関して何かアイデアがあれば、ぜひお聞かせください**。