```markdown
+ import { Callout } from 'nextra/components'

# DataDog

FeatBitはDataDogと次のように統合する方法を提供します：

1. [Datadog RUM integrationを使用](https://docs.datadoghq.com/real_user_monitoring/guide/setup-feature-flag-data-collection/?tab=browser#analyze-your-feature-flag-performance-in-rum)し、フィーチャーフラグの評価データをDataDogに送信します。
2. [Datadog events integrationを使用](https://docs.datadoghq.com/api/?lang=bash#events)し、FeatBitからのアクティビティを受信し、フィーチャーフラグの更新などを行います。
3. DataDogのメトリックが一定の閾値以下に下がった場合、フィーチャーフラグをロールバックするためのフラグトリガーを使用します。
4. フィーチャーフラグのInsightsをDataDog APMにエクスポートします。

## Datadog RUM integrationの使用

[Feature Flag Tracking](https://docs.datadoghq.com/real_user_monitoring/feature_flag_tracking/) を使用すると、特定の機能を表示しているユーザーや導入した変更がユーザーエクスペリエンスやパフォーマンスにどのような影響を与えているかを判断できるため、ユーザーエクスペリエンスとパフォーマンスモニタリングの可視性が向上します。

### フィーチャーフラグデータ収集のセットアップ

始めるには、[DataDogフィーチャーフラグデータの収集を設定](https://docs.datadoghq.com/real_user_monitoring/guide/setup-feature-flag-data-collection)する必要があります。**javascript/typescript** プロジェクトの場合、RUM SDKを初期化し、`enableExperimentalFeatures`の初期化パラメータに`["feature_flags"]`を設定する必要があります。これにより、フィーチャーフラグトラッキング機能が有効になり、フィーチャーフラグの評価データがDataDogに送信されます。

```javascript
datadogRum.init({
  applicationId: "sample-application-id",
  clientToken: "sample-client-token",
  site: "datadoghq.com",
  service: "demo-app",
  env: "dev",
  version: "1.0.0",
  sessionSampleRate: 100,
  sessionReplaySampleRate: 100,
  trackUserInteractions: true,
  trackResources: true,
  trackLongTasks: true,
  defaultPrivacyLevel: "mask-user-input",
  // This enables the beta feature flag tracking
  enableExperimentalFeatures: ["feature_flags"]
});

datadogRum.startSessionReplayRecording();
```

その後、`datadogRum`パッケージに組み込まれた`addFeatureFlagEvaluation`メソッドを使用して、`FeatBit`フィーチャーフラグを評価します。

```javascript
import { datadogRum } from "@datadog/browser-rum";
import fbClient from "featbit-js-client-sdk";

const flagEvalResult = fbClient.variation("feature-flag-key", flagsDefaultValues[prop] || '')
datadogRum.addFeatureFlagEvaluation("feature-flag-key", flagEvalResult);
```

どこでも2行のコードを書きたくない場合は、`.variation(...)`と`.addFeatureFlagEvaluation(...)`を関数でカプセル化することができます。[Reactサンプル](https://github.com/featbit/featbit-samples/blob/main/samples/dino-game/interactive-demo-react/src/featBit/featBitSlice.js) や [Vueサンプル](https://github.com/featbit/featbit-samples/blob/main/samples/dino-game/interactive-demo-vue/src/featbit.js) のプロジェクトでは、`Flags Proxy`を作成し、フィーチャーフラグ値の統一されたインタフェースを提供します。そのため、Flags ProxyにaddFeatureFlagEvaluationを追加してこのように使用できます。

```javascript
import { datadogRum } from "@datadog/browser-rum";
import fbClient from "featbit-js-client-sdk";

export const createFlagsProxy = () => {
    return new Proxy({}, {
        get(target, prop, _) {
          let returnValue = ''
          if(typeof prop === 'string' && !prop.startsWith('__v_')){
            returnValue = fbClient.variation(prop, flagsDefaultValues[prop] || '');
            datadogRum.addFeatureFlagEvaluation(prop, returnValue);
          }
          return returnValue;
        }
    })
}
```

そのため、コードでフィーチャーフラグを呼び出すと、自動的にフィーチャーフラグの評価データがDataDogに送信されます。

```javascript
// Piniaを使用したVueの例、以下のコードはフィーチャーフラグの値のリアルタイムの更新も保証します
<DinoGameCore v-if="featBitStore.flags['game-runner']== true"
              :difficulty="featBitStore.flags['difficulty-mode']" />

// Reduxを使用したReactの例、以下のコードはフィーチャーフラグの値のリアルタイムの更新も保証します
featureFlags["game-runner"] == true ? 
  <DinoGameCore difficulty={featureFlags["difficulty-mode"]} /> : <>

```


<Callout type="info">
**注意**: 上記のチュートリアルでは、ブラウザでのフィーチャーフラグの評価データの収集方法を示しました。iOSやAndroidなどの他のプラットフォームの場合は、[DataDogドキュメント](https://docs.datadoghq.com/real_user_monitoring/guide/setup-feature-flag-data-collection/?tab=ios#custom-feature-flag-management)を参照してください。
</Callout>


### RUMとAPMでフィーチャーフラグのパフォーマンスを分析する


FeatBitをDataDogと統合した後、[RUMでフィーチャーフラグのパフォーマンスを分析](https://docs.datadoghq.com/real_user_monitoring/guide/setup-feature-flag-data-collection/?tab=browser#analyze-your-feature-flag-performance-in-rum)することができます。DataDogのRUMダッシュボードを使用して**Sessions**、**Views**、**Errors**をフィルタリングできます。たとえば、指定した時間枠内でFeatBitが評価されたビューで発生したすべてのエラーを見つけることができます。

![](../integrations/assets/datadog/filter-errors-with-feature-flag-in-rum.webp)

フィーチャーフラグを表示し、分析するには、[DataDog Feature Flags Trackingチュートリアル](https://docs.datadoghq.com/real_user_monitoring/feature_flag_tracking/#view-your-feature-flags)を参照してください。

[DataDog APM](https://www.datadoghq.com/product/apm/)を使用している場合、DataDogはフロントエンドのフィーチャーフラグデータをトレースに接続する方法を提供します。[Rum and Tracesを接続する](https://docs.datadoghq.com/real_user_monitoring/connect_rum_and_traces/?tab=browserrum) こうすることで、フロントエンドとバックエンドの両方のエラーに基づいてアラートを受け取ることができます。

## Datadog events integrationの使用

Datadog統合を使用すると、FeatBitからの任意のアクティビティを受信するために[Datadog Events](https://docs.datadoghq.com/api)を設定できます。フィーチャーフラグの更新やFeatBitに新しいアカウントメンバーを追加するなど、何かが変更されると、FeatBitはDatadogにイベントを送信します。この統合を使用すると、FeatBitでの機能変更がアプリやインフラのメトリックにどのように影響するかを相関付けて理解することができます。
次のイメージは、特定のサービスAPMダッシュボードでフィーチャーフラグのイベントと障害の検出との相関関係が示されています。フィーチャーフラグをオフにした後、障害が消えました。

![](../integrations/assets/datadog/dashboard-apm-error-turn-off-events.png)

完全なイベント統合はまだ進行中です。しかし、現在はMongoDBの`AuditLogs`コレクションのイベント変更を監視するためのプログラムを作成できます。.NETでの[コレクション変更の監視](https://mongodb.github.io/mongo-csharp-driver/2.7/reference/driver/change_streams/)の公式チュートリアルがあります。

![](../integrations/assets/datadog/mongodb-auditlog-collection.png)

次に、[DataDog Events API](https://docs.datadoghq.com/api/latest/events/#post-an-event)を使用して、これらのアクティビティをDataDogに送信できます。

<Callout type="info" emoji='💡'>
この実装の機能開発を加速させてほしい場合は、お知らせください。
</Callout>


## DataDogとのフラグトリガーの使用

[DataDogのWebhook](https://docs.datadoghq.com/integrations/webhooks/)を使用すると、メトリックアラートがトリガーされたときにサービスに通知することができます。Webhookの構成では、[FeatBitフラグトリガー](../feature-flags/feature-workflow/flag-triggers)を直接呼び出したり、[FeatBit REST API](../api-docs/using-featbit-rest-api)を使用して特定のユーザーグループに展開/ロールバックを呼び出したりできます。WebHookをフラグトリガーに構成する方法は次のとおりです：

1. フィーチャーフラグでまず、フラグトリガーを作成する必要があります。[Workflow/Flag Triggers](/feature-flags/feature-workflow/flag-triggers)を参照してください。

![](../integrations/assets/datadog/flag-trigger.png)

2. DataDogインテグレーションで、新しいWebHookを作成して、新しいWebHookにフラグトリガーURLをコピーします。

![](../integrations/assets/datadog/create-webhook.png)

3. モニターページに移動し、検索クエリや条件を持つメトリックを作成します。その後、アラートのテキストに`@webhook-name_of_the_webhook`を追加します。条件で設定された閾値を下回ったとき、WebHookがトリガーされます。

![](../integrations/assets/datadog/monitor-notify-team.png)

4. WebHookがトリガーされると、フィーチャーフラグが自動的にオン/オフになります。

## Feature FlagsのInsightsをDataDog APMにエクスポート
```
```markdown
Datadog provides various tools and features for monitoring the performance and behavior of applications and systems. You can use **Metrics** to assess the health of your environment at a glance. Visualize how quickly users are loading your website, or the average memory consumption of your servers, for instance. Once you identify a problem, you can use **logs** and **tracing** to further troubleshoot.

In additional sending activity events to APM as mentioned above ([Using the Datadog events integration](#using-the-datadog-events-integration)), you can deeply integrate with DataDog APM and Metrics by exporting FeatBit's Feature Flag Insights data (for both front-end and back-end feature flag usage data) and custom event data to DataDog via **ClickHouse** in the Pro version or **MongoDB** in the Standard version. Then you can choose Metrics for an overview of flag usage (counts, high-level impact) and Traces for deep insight into how flags affect individual requests. Using both metrics and traces can provide a comprehensive view of feature flag behavior and application performance.

**We hope to hear from your if you have any ideas about this implementation**.
```

```markdown
Datadogは、アプリケーションやシステムのパフォーマンスや動作を監視するためのさまざまなツールや機能を提供しています。**メトリクス**を使用して、環境の健全性を一目で評価できます。例えば、ユーザーがウェブサイトをどれだけ速く読み込んでいるか、サーバーの平均メモリ消費量などを視覚化できます。問題を特定したら、**ログ**と**トレース**を使用してさらにトラブルシューティングできます。

上記のようにAPMにアクティビティイベントを送信するだけでなく、DataDog APMとメトリクスと深く統合することができます。FrontendとBackendのフィーチャーフラグ使用データに関するFeatureFlagInsightsデータやカスタムイベントデータをPro版では**ClickHouse**、Standard版では**MongoDB**を介して DataDog にエクスポートします。その後、メトリクスを選択してフラグの使用状況（カウント、高レベルの影響）の概要を、トレースを選択してフラグが個々のリクエストにどのように影響を与えるかの洞察を得ることができます。メトリクスとトレースの両方を使用することで、フィーチャーフラグの動作とアプリケーションパフォーマンスの包括的なビューを提供できます。

**この実装に関するアイデアがありましたら、お知らせいただけると嬉しいです**。
```