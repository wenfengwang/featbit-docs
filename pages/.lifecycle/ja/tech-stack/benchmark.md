# ベンチマーク

FeatBitの目標の一つは、スケーラブルで高速なリアルタイムのフィーチャーフラグ管理サービスを作成することです。この点において、我々は同時接続を処理する能力に焦点を当てており、これは主に評価サーバーサービスの性能に依存しています。この文書は、評価サーバーのパフォーマンスレポートを孤立した最小の環境で提供します。

## テストの目的

以下に指定されたパフォーマンス要件を評価する必要があります。

評価サーバーは、応答時間とエラーレートの観点から業界標準のレベルのサービスを提供することで、1秒あたり1000の新しい接続を処理できる必要があります。99パーセンタイル（P99）の応答時間は200ミリ秒未満でなければならず、受け入れ可能なエラーレートは1％未満でなければなりません。この基準により、高信頼なサービスを提供しながら、評価サーバーの最大容量を確保します。

FeatBitが特定の時間に保持できる最大のユーザー接続数は、データ同期が行われていない場合はCPUとメモリの使用率が低いことが観察されたため、この文書ではカバーされません。接続されたユーザーに変更をプッシュする能力は、将来のレポートで取り上げられる予定です。

## 一般的なテスト条件

以下のテスト条件は、実際の使用状況をシミュレートするために最も適しています。

* 1秒あたりの新しい接続数（データ同期を含む）
* 平均P99応答時間 **(1)**
* ユーザーアクション：接続確立後にデータ同期リクエストを行う

**(1)** 応答時間：データ同期リクエストを送信してから応答を受信するまでの経過時間。

## 環境

我々は、評価サーバーサービスをホストするために一般的に利用可能なAWS EC2サービスを選択しました。インスタンスタイプは**t2.microで1 vCPUと1 GiB RAM**で、無料利用枠の対象です。

テストを実行するためにEC2インスタンスを使用し、これにより結果に対するネットワークの影響を最小限に抑えることができます。

## 実行されたテスト

**テストの期間**：180秒

**負荷の種類**：0から1000、1100、1200の新しい接続数に徐々に負荷を増やす

**テスト回数**：それぞれ1000、1100、1200回のケースについて10回

## テスト結果

実施されたテストでは、評価サーバーは限界負荷時にのみ所望のサービス品質を維持することが示されました。1秒あたり1100件まで達すると、1200/秒になると一部のエラーが観測されます。

**応答時間**

<table><thead><tr><th width="378">1秒あたりの新しい接続数</th><th width="100">平均（ms）</th><th width="100">P95（ms）</th><th>P99（ms）</th></tr></thead><tbody><tr><td>1000</td><td>5.42</td><td>24.7</td><td>96.70</td></tr><tr><td>1100</td><td>9.98</td><td>55.51</td><td>170.30</td></tr><tr><td>1200</td><td>34.17</td><td>147.91</td><td>254.60</td></tr></tbody></table>

**ピークCPU利用率 %**

| 1秒あたりの新しい接続数 | ランプアップステージ | 安定ステージ |
| --------------------------- | --------------------- | -------------- |
| 1000                        | 82                    | 26             |
| 1100                        | 88                    | 29             |
| 1200                        | 91                    | 31             |

**ピークメモリ利用率 %**

| 1秒あたりの新しい接続数 | ランプアップステージ | 安定ステージ |
| --------------------------- | --------------------- | -------------- |
| 1000                        | 55                    | 38             |
| 1100                        | 58                    | 42             |
| 1200                        | 61                    | 45             |

## 結論

最小のハードウェア設定である**AWS EC2 t2.micro（1 vCPU + 1 G RAM）**を使用すると、評価サーバーは1秒あたり1100件までの新しい接続を処理することができ、特定の時間に保持できる最大接続数は22000件に達します（これは限界ではありません）。

テスト中に測定されたWebサーバーのリソース利用状況は、ハードウェアのボトルネックがCPUであることを示しています。これは、CPUがデータ同期段階でフィーチャーフラグを評価する際に強く使用されるため理解できます。より多くのvCPUを持つインスタンス（またはコンピューティング最適化されたインスタンス）を使用することで、新しい接続数の容量を確実に増やすことができます。

報告されたパフォーマンスは、無視できるコスト（無料利用枠の対象）で中小企業にとって十分すぎると考えています。ビジネスが成長すると、サービスを水平方向にスケーリングすることで容易に容量を増やすことができます。&#x20;

## テストで使用されたデータセット

上記のテストでは、5つのフィーチャーフラグと2つのセグメントを使用しました。テストデータは以下に添付されています。

[フィーチャーフラグテストサンプルファイル](https://github.com/featbit/featbit-docs/blob/main/pages/tech-stack/assets/flags.json)

[セグメントテストサンプルファイル](https://github.com/featbit/featbit-docs/blob/main/pages/tech-stack/assets/segments.json)