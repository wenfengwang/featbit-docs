import { Callout } from 'nextra/components'

# パーセンテージ展開

## 概要 <a href="#overview" id="overview"></a>

このトピックでは、パーセンテージ展開を使用して、新機能をユーザーに段階的にリリースする方法について説明します。

パーセンテージ展開を使用すると、リスクを管理して機能をユーザーに段階的にリリースすることができます。新機能をランダムな一部のユーザーに展開し、正常に機能していると確信できるようになるにつれて、時間をかけてパーセンテージを増やすことができます。

## パーセンテージ展開の作成 <a href="#creating-percentage-rollouts" id="creating-percentage-rollouts"></a>

フラグのターゲティングルールまたはフラグのデフォルトルールでパーセンテージ展開を作成することができます。

デフォルトルールでのパーセンテージ展開のイメージは以下の通りです：

![](../../feature-flags/assets/targeting-users-with-flags/percentage-rollouts/001.png)

この例では、ユーザーの25%が新機能を受け取ります。新機能が期待どおりに動作する場合、ユーザーが新機能を受け取るパーセンテージを段階的に増やして、最終的に100%になるまで増やすことができます。

ユーザーのごく一部に変動を展開したい場合、変動に0.1%未満を割り当てることができます。最大で三桁の小数点を使用できます。例えば、0.125%です。

## パーセンテージ展開のロジックの理解 <a href="#understanding-percentage-rollout-logic" id="understanding-percentage-rollout-logic"></a>

パーセンテージ展開を設定すると、各ユーザーはユーザーキーに基づいて特定の変動を受け取ります。

パーセンテージ展開のロジックは、ユーザーキーIdに基づいたハッシュを生成します。SDKはこのハッシュを使用して、そのユーザーに対するパーセンテージ値を生成します。その値とパーセンテージ展開の値を比較することで、ユーザーがどの変動を受け取るかが決まります。ハッシュは0から2147483648のパーティションを持っています。フラグの変動を割り当てる際に、ハッシュはそれぞれのパーティションのユーザーに0から2147483648の値を割り当てます。例えば、変動Aに50%を割り当てる場合、FeatBitはハッシュのパーティション1から1073741824までに変動Aを提供します。

パーセンテージ展開の一般的なユースケースは、フラグの変動が100%のユーザーに展開されるまで、時間の経過とともにフラグの対象ユーザーのパーセンテージを段階的に増やすことです。ユーザーへの変動の割り当て割合を変更すると、0から2147483648のハッシュリスト内のパーティションの位置に基づいて、それらのユーザーは異なるフラグの変動が再割り当てされます。例えば、変動Aの受け取り割合を50%から70%に変更すると、パーティション1073741825から1503238554までが、既に変動Aを受け取っているパーティションのセットに追加されます。

### 高度な展開の使用 <a href="#using-advanced-rollouts" id="using-advanced-rollouts"></a>

**ディスパッチによる**メニューで、ユーザー属性のいずれかを基に変動をユーザーに割り当てることができます。

たとえば、ユーザーの25%にあたるユーザーに機能を展開することができますが、ランダムに変動に割り当てられるのではなく、ユーザーは`team-region`属性の値に基づいて変動に割り当てられます。これにより、FeatBitは同じ属性値のユーザーを全て同じ変動に割り当てることができます。

高度な展開のイメージは以下の通りです：

![](../../feature-flags/assets/targeting-users-with-flags/percentage-rollouts/002.webp)