import { Callout } from 'nextra/components'

# ターゲティングルール

## 概要 <a href="#overview" id="overview"></a>

このトピックでは、組み込みおよびカスタムユーザー属性に基づいてユーザーセグメントをターゲットにするためのターゲティングルールの使用方法について説明します。

## ターゲティングルールの作成 <a href="#creating-targeting-rules" id="creating-targeting-rules"></a>

ターゲティングルールは一つ以上の条件を持つことができます。

各条件は三つの部分から成り立っています：

* 組み込みまたはカスタムの**ユーザー属性**。これは条件の影響範囲を定義します。例えば、メールアドレスのみをターゲットにする場合などです。詳細は[ユーザー属性](targeting-rules.mdx#user-attributes)をご覧ください。
* **オペレーター**。これは属性の特徴を区別するためのものです。例えば、特定の拡張子で終わるメールアドレスに条件を限定する場合などです。条件がオペレーターが追跡する複数の値を指定している場合、オペレーターは配列を繰り返し処理します。詳細は[オペレーター](targeting-rules.mdx#operators)をご覧ください。
* **値**。これは、あなたが指定した値によって属性を識別します。例えば`gmail.com`のように。

以下はユーザーターゲティングルールの画像です：

![](../../feature-flags/assets/targeting-users-with-flags/targeting-rules/001.webp)

メールアドレスが`gmail.com`で終わるすべてのユーザーに`true`を提供するルールを作成するには：

1. **ルールを追加**アイコンをクリックします。

![](../../feature-flags/assets/targeting-users-with-flags/targeting-rules/002.webp)

2. ルールに名前を入力します。
3. **属性を選択**メニューから`email`を選択します。
4. **オペレーターを選択**メニューから`ends with`を選択します。
5. **値**フィールドに`gmail.com`を入力します。
6. **提供**メニューから`true`を選択します。
7. **保存**をクリックします。

ターゲティングルールが`null`値のカスタム属性を参照している場合、そのルールはフラグによってスキップされます。

ルールには複数の条件を追加することができます。ここでは、ルールが複数の条件と値をどのように扱うかを説明します：

* ユーザーはルールにマッチするためには_すべての条件_を満たす必要があります。どれか一つの条件でも満たされない場合、そのユーザーはルールにマッチしません。
* 条件に複数の値がある場合、FeatBitは_いずれかの値_に一致する場合に条件が満たされたとみなします。

#### パーセンテージロールアウト <a href="#percentage-rollouts" id="percentage-rollouts"></a>

ルールにマッチするユーザーの一部にのみ特定のバリエーションを提供したい場合、パーセンテージロールアウトを使用できます。

以下はパーセンテージロールアウトセクションの画像です：

この例では、25%のユーザーが`true`バリエーションを受け取ります。

![](../../feature-flags/assets/targeting-users-with-flags/targeting-rules/003.webp)

詳細は[パーセンテージロールアウト](percentage-rollouts.md)をご覧ください。

#### 実験 <a href="#experimentation" id="experimentation"></a>

ターゲティングルールを保存した後、**A/Bテストルールを設定**ボタンをクリックしてルールに対する実験を実行できます。詳細は[実験の作成](../../experimentation/creating-experiments.md)をご覧ください。

以下はフラグのターゲティングルールにある**A/Bテストルールを設定**ボタンの画像です：

![](../../feature-flags/assets/targeting-users-with-flags/targeting-rules/004.webp)

#### ユーザー属性 <a href="#user-attributes" id="user-attributes"></a>

FeatBitにはユーザーのための組み込み属性が含まれています。以下は一般的なユーザー属性の例です：

* `keyId`
* `name`

組み込みユーザー属性の完全なリストについては[組み込みユーザー属性](../users-and-user-segments/user-attributes.md)をご覧ください。

FeatBitでは、独自のカスタムユーザー属性を作成することもできます。例えば、プラン、グループ、ロール、場所、または組織に基づいてユーザーをターゲットにすることができます。カスタムユーザー属性を使用すると、通常プランのユーザーには一部の機能を表示し、プレミアムプランのユーザーには追加機能を表示することができます。または、ユーザーの30%ではなく、組織の30%に新機能をロールアウトすることもできます。

詳細は[ユーザー属性](../users-and-user-segments/user-attributes.md)をご覧ください。

#### オペレーター <a href="#operators" id="operators"></a>

FeatBitは以下のオペレーターをサポートしています：

| オペレーター | 属性タイプ | 意味 |
| ------------------------------------ | ------------- | ------------ |
| いずれかである`=`、いずれかではない`!=` | 文字列、数値、ブール、日付 | 完全一致 |
| で終わる、で終わらない | 文字列 | 文字列のサフィックス一致 |
| で始まる、で始まらない | 文字列 | 文字列のプレフィックス一致 |
| 一致する、一致しない | 文字列 | 正規表現一致 |
| 含む、含まない | 文字列 | 部分文字列一致 |
| より大きい`>`、より小さい`<`、以上`>=`、以下`<=` | 数値 | 数値比較 |
| セグメントに含まれる、セグメントに含まれない | セグメント名 | ユーザーが指定されたセグメントのターゲティングルールによって含まれるか除外されるか。詳細は[ユーザーセグメント](../users-and-user-segments/user-segments)をご覧ください。 |

## デフォルトルールの設定 <a href="#setting-the-default-rule" id="setting-the-default-rule"></a>

FeatBitは、ページ上のどのターゲティングルールにも一致しないユーザーのために最終的なデフォルトルールを定義します。他のルールと同様に、特定のバリエーションを提供するか、残りのユーザーにパーセンテージロールアウトを適用するかを選択できます。

以下はパーセンテージロールアウトセクションの画像です：

![](../../feature-flags/assets/targeting-users-with-flags/targeting-rules/005.webp)

これで、他のルールによってターゲットされていないすべてのユーザーの30%が`true`を受け取ります。

ユーザーキーやカスタム属性に基づいてユーザーをターゲットにしたくない場合、デフォルトルールを使用してすべてのユーザーに対するフラグのロールアウトを制御できます。

## デフォルトオフバリエーションの設定 <a href="#setting-the-default-off-variation" id="setting-the-default-off-variation"></a>

トグルがオフの場合、FeatBitは機能フラグのデフォルトオフバリエーションを提供します。ブール型フラグの場合、デフォルトオフバリエーションは`false`に設定されます。多変量フラグの場合、カスタムバリエーションの1つを選択します。ブール型フラグと多変量フラグの両方で、デフォルトオフバリエーションは**ターゲティング**タブでカスタマイズできます。

## 評価順序 <a href="#evaluation-order" id="evaluation-order"></a>

**ターゲティング**タブでは、以下の順序でルールが評価されます：

### 機能がONの場合

1. 個々のユーザーをターゲットにする\
![](../../feature-flags/assets/targeting-users-with-flags/targeting-rules/006.webp)
   1. 第一バリエーション
   2. 第二バリエーション
   3. 第三バリエーション
   4. ...
2. ユーザーカスタムルールをターゲットにする\
![](../../feature-flags/assets/targeting-users-with-flags/targeting-rules/007.webp)
   1. UIに表示される最初のルール
   2. UIに表示される二番目のルール
   3. UIに表示される三番目のルール
   4. ...
3. **デフォルトルール**の設定を通じて残りのユーザーをターゲットにする

<Callout type="info">
ユーザーが複数のルールに一致する場合、最初に一致したルールが適用されます。
カスタムルールは、ルールの左端をクリックして上下にドラッグすることで並べ替えることができます。
</Callout>

### 機能がOFFの場合

OFFセクションで事前に定義されたバリエーションを提供する\

![](../../feature-flags/assets/targeting-users-with-flags/targeting-rules/008.webp)



