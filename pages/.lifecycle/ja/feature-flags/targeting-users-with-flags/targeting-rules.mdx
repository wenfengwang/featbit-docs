```markdown
import { Callout } from 'nextra/components'

# ターゲットルール

## 概要 <a href="#overview" id="overview"></a>

このトピックでは、組み込みおよびカスタムユーザ属性に基づいてユーザセグメントをターゲットにするためのターゲットルールの使用方法について説明します。

## ターゲットルールの作成 <a href="#creating-targeting-rules" id="creating-targeting-rules"></a>

ターゲットルールには1つ以上の条件が設定できます。

各条件には3つの部分があります。

* ターゲット条件の影響範囲を定義する組み込みまたはカスタム**ユーザ属性**。たとえば、特定のメールアドレスのみをターゲットにするようにします。詳細については、「[ユーザ属性](targeting-rules.mdx#user-attributes)」を参照してください。
* 属性の異なる特性を設定する**オペレータ**。たとえば、特定の拡張子で終わる電子メールを条件に制限することができます。条件に複数の値を指定する場合、オペレータは配列を反復処理します。詳細については、「[オペレータ](targeting-rules.mdx#operators)」を参照してください。
* 指定した値によって属性を識別する**値**。たとえば、`gmail.com`のような特定の値を指定します。

ユーザターゲットルールのイメージは次のとおりです：

![](../../feature-flags/assets/targeting-users-with-flags/targeting-rules/001.webp)

`gmail.com`で終わるすべてのユーザに`true`を提供するルールを作成するには：

1. **ルールの追加**アイコンをクリックします。

![](../../feature-flags/assets/targeting-users-with-flags/targeting-rules/002.webp)

2. ルールの名前を入力します。
3. **属性を選択**メニューから`email`を選択します。
4. **オペレータを選択**メニューから`ends with`を選択します。
5. **値**フィールドに`gmail.com`を入力します。
6. **提供**メニューから`true`を選択します。
7. **保存**をクリックします。

ターゲットルールで`null`値を持つカスタム属性を参照する場合、そのルールはスキップされます。

1つのルールに複数の条件を追加できます。複数の条件と値を処理する方法は次のとおりです：

* ユーザはルールのすべての条件を満たす必要があります。条件のいずれかが満たされない場合、ユーザはルールに一致しません。
* 条件に複数の値がある場合、FeatBitは値のいずれかに一致すると条件が満たされると見なします。

#### パーセンテージの展開 <a href="#percentage-rollouts" id="percentage-rollouts"></a>
ルールに一致するユーザの一部のみに特定の変更を配信したい場合、パーセンテージの展開を行うことができます。

パーセンテージ展開セクションのイメージは次のとおりです：

この例では、25%のユーザが`true`の変更を受け取ります。

![](../../feature-flags/assets/targeting-users-with-flags/targeting-rules/003.webp)

詳細については、「[パーセンテージ展開](percentage-rollouts.md)」を参照してください。

#### 実験 <a href="#experimentation" id="experimentation"></a>
ターゲットルールを保存した後、**A/Bテストルールを設定**ボタンをクリックしてルールで実験を実行できます。詳細については、「[実験の作成](../../experimentation/creating-experiments.md)」を参照してください。

フラグのターゲットルールにある**A/Bテストルールを設定**ボタンのイメージは次のとおりです：

![](../../feature-flags/assets/targeting-users-with-flags/targeting-rules/004.webp)

#### ユーザ属性 <a href="#user-attributes" id="user-attributes"></a>
FeatBitには、ユーザ向けに組み込み属性が含まれています。共通のユーザ属性の例は次のとおりです：

* `keyId`
* `name`

組み込みユーザ属性の完全なリストについては、「[組み込みユーザ属性](../users-and-user-segments/user-attributes.md)」を読んでください。

FeatBitでは、独自のカスタムユーザ属性を作成することもできます。たとえば、プラン、グループ、役割、場所、または組織に基づいてユーザをターゲットにしたい場合があります。カスタムユーザ属性を使用すると、通常のプランのユーザには特定の機能を表示し、プレミアムプランのユーザには追加の機能を表示することができます。また、ユーザの30%ではなく、組織の30%に新機能を展開することもできます。

詳細については、「[ユーザ属性](../users-and-user-segments/user-attributes.md)」を読んでください。

#### オペレータ <a href="#operators" id="operators"></a>
FeatBitは、次のオペレータをサポートしています：

| オペレータ | 属性タイプ | 意味 |
| ------------------------------------ | ------------- | ------------ |
| is one of `=`, is not one of `!=`  | 文字列、数値、真偽値、日付 | 完全一致 |
| ends with, does not end with | 文字列 | 文字列のサフィックス一致 |
| starts with, does not start with | 文字列 | 文字列のプレフィックス一致 |
| matches, does not match | 文字列 | 正規表現一致 |
| contains, does not contain | 文字列 | 部分文字列一致 |
| greater than `>`, less than `<`, greater than or equal to `>=`, less than or equal to `<=` | 数値 | 数値比較 |
| user is in segment, user is not in segment | セグメント名 | 指定されたセグメントのターゲットルールでユーザが含まれるか除外されるか。詳細については、「[ユーザセグメント](../users-and-user-segments/user-segments)」を読んでください。 |

## デフォルトルールの設定 <a href="#setting-the-default-rule" id="setting-the-default-rule"></a>
FeatBitでは、ページのターゲットルールに一致しないどのユーザに対しても最終的なデフォルトルールが定義されています。他のルールと同様に、残りのユーザに特定の変更を提供するか、パーセンテージの展開を適用するかを選択できます。

パーセンテージ展開セクションのイメージは次のとおりです：

![](../../feature-flags/assets/targeting-users-with-flags/targeting-rules/005.webp)

これで、その他のいかなるルールにも対象とされていない全ユーザのうち、30%に`true`が提供されます。

ユーザキーまたはカスタム属性に基づいてユーザをターゲットにしたくない場合は、デフォルトルールを使用して全ユーザのフラグ展開を制御できます。

## デフォルトのOFF変更の設定 <a href="#setting-the-default-off-variation" id="setting-the-default-off-variation"></a>
トグルをオフにすると、FeatBitは機能フラグのデフォルトオフ変更を提供します。ブールフラグの場合、デフォルトのOFF変更は`false`に設定されます。マルチバリエートフラグの場合、カスタム変更の一つを選択します。ブールおよびマルチバリエートフラグのデフォルトのOFF変更を**Targeting**タブでカスタマイズできます。

## 評価順序 <a href="#evaluation-order" id="evaluation-order"></a>
**Targeting**タブは次の順序でルールを評価します：

### 機能がONになっている場合

1. 個々のユーザをターゲットにする \
![](../../feature-flags/assets/targeting-users-with-flags/targeting-rules/006.webp)
   1. 最初の変更
   2. 2番目の変更
   3. 3番目の変更
   4. ...
2. ユーザカスタマイズルールをターゲットにする\
![](../../feature-flags/assets/targeting-users-with-flags/targeting-rules/007.webp)
   1. UIで表示される最初のルール
   2. UIで表示される2番目のルール
   3. UIで表示される3番目のルール
   4. ...
3. 残りのユーザを**デフォルトルール**で設定する

<Callout type="info">
ユーザが複数のルールに一致する場合、最初に一致したルールが適用されます。
カスタマイズしたルールは、ルールの左端をクリックして上下にドラッグすることで並べ替えることができます。
</Callout>

### 機能がOFFになっている場合

**OFF**セクションで事前に定義された変更を提供します\

![](../../feature-flags/assets/targeting-users-with-flags/targeting-rules/008.webp)
```